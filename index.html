<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enjoy The Gifts-Store system</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="app-icon.jpg" type="image/jpeg">
    <style>
        :root {
            /* ألوان الوضع النهاري */
            --primary: #6a5acd;
            --primary-light: #8a7cff;
            --secondary: #9370db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --light-bg: #f8f9ff;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --gray: #7f8c8d;
            --card-bg: #ffffff;
            --card-shadow: rgba(99, 99, 99, 0.15) 0px 2px 8px 0px;
            --border: #e0e0e0;
            --expense: #e74c3c;
            --expense-light: rgba(231, 76, 60, 0.1);
            --income: #2ecc71;
            --income-light: rgba(46, 204, 113, 0.1);
            /* ألوان الوضع الليلي */
            --dark-bg: #121212;
            --dark-card: #1e1e1e;
            --dark-text: #e0e0e0;
            --dark-border: #333333;
        }

        /* شاشة الترحيب والمزامنة */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
        }

        .welcome-content {
            text-align: center;
            max-width: 500px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .welcome-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .welcome-title {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .store-setup {
            margin-top: 30px;
        }

        .store-id-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }

        .store-id-text {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        .store-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            text-align: center;
            margin: 15px 0;
        }

        .store-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .welcome-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            display: inline-block;
        }

        .welcome-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .welcome-btn.primary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            border-color: transparent;
        }

        .welcome-btn.primary:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            z-index: 100;
            border: 1px solid var(--border);
        }

        body.dark-mode .sync-status {
            background: var(--dark-card);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .sync-indicator.offline {
            background: var(--danger);
        }

        .sync-indicator.syncing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .hidden {
            display: none !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            transition: background-color 0.4s, color 0.3s, border-color 0.4s;
        }
        body {
            background: var(--light-bg);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            animation: headerGlow 3s infinite alternate;
        }
        @keyframes headerGlow {
            0% { box-shadow: var(--card-shadow); }
            100% { box-shadow: 0 0 20px rgba(106, 90, 205, 0.3), var(--card-shadow); }
        }
        body.dark-mode header {
            background: linear-gradient(90deg, #2c2250, #3a2a6c);
        }
        header::before {
            content: "";
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        header::after {
            content: "";
            position: absolute;
            bottom: -30px;
            left: -30px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2;
            animation: fadeInUp 0.5s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .logo i {
            font-size: 2.5rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
        }
        .logo span {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 100;
        }
        body.dark-mode .theme-toggle {
            color: var(--dark-text);
        }
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg);
        }
        .theme-toggle:active {
            transform: scale(0.9);
        }
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            position: relative;
            z-index: 10;
        }
        body.dark-mode .nav-tabs {
            background: var(--dark-card);
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            font-size: 1.1rem;
            position: relative;
        }
        body.dark-mode .tab {
            color: var(--dark-text);
        }
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: rgba(106, 90, 205, 0.05);
        }
        body.dark-mode .tab.active {
            background: rgba(106, 90, 205, 0.1);
        }
        .tab:hover:not(.active) {
            background: rgba(106, 90, 205, 0.08);
        }
        body.dark-mode .tab:hover:not(.active) {
            background: rgba(106, 90, 205, 0.15);
        }
        .tab i {
            margin-left: 8px;
        }
        .tab-content {
            display: none;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            animation: fadeIn 0.5s;
            border: 1px solid rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .tab-content {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section-title {
            font-size: 1.8rem;
            margin: 0 0 25px;
            color: var(--primary);
            position: relative;
            padding-bottom: 15px;
            font-weight: 700;
        }
        body.dark-mode .section-title {
            color: var(--primary-light);
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 80px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }
        body.dark-mode .form-label {
            color: var(--dark-text);
        }
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
        }
        body.dark-mode .form-control {
            background: #2a2a2a;
            border: 2px solid var(--dark-border);
            color: var(--dark-text);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2);
        }
        body.dark-mode .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.4);
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #5949b8;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(106, 90, 205, 0.3);
        }
        body.dark-mode .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(106, 90, 205, 0.5);
        }
        .btn-sm {
            padding: 10px 20px;
            font-size: 1rem;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-info {
            background: var(--info);
            color: white;
        }
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        .btn-block {
            display: block;
            width: 100%;
        }
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin: 25px 0;
            background: white;
            border: 1px solid var(--border);
        }
        body.dark-mode .table-container {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            min-width: 800px;
        }
        body.dark-mode table {
            background: var(--dark-card);
        }
        th, td {
            padding: 18px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            font-size: 1.1rem;
        }
        body.dark-mode th, 
        body.dark-mode td {
            border-bottom: 1px solid var(--dark-border);
            color: var(--dark-text);
        }
        th {
            font-weight: 700;
            background: rgba(106, 90, 205, 0.05);
        }
        body.dark-mode th {
            background: rgba(106, 90, 205, 0.1);
        }
        thead {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
        }
        body.dark-mode thead {
            background: linear-gradient(90deg, #2c2250, #3a2a6c);
        }
        tbody tr:hover {
            background: rgba(106, 90, 205, 0.03);
        }
        body.dark-mode tbody tr:hover {
            background: rgba(106, 90, 205, 0.1);
        }
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            display: inline-block;
        }
        .status-in-stock {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
        }
        .status-low-stock {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        .status-out-of-stock {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }
        .status-pending {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
            cursor: pointer;
        }
        .status-in-progress {
            background: rgba(52, 152, 219, 0.15);
            color: var(--info);
            cursor: pointer;
        }
        .status-completed {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
            cursor: pointer;
        }
        .status-cancelled {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            cursor: pointer;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-col {
            flex: 1;
        }
        .sale-product-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
        }
        .sale-product-item:hover {
            box-shadow: 0 5px 15px rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .sale-product-item {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }
        .sale-product-item::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            border-radius: 0 12px 12px 0;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            border: 1px solid var(--border);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        body.dark-mode .product-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .product-card:hover {
            box-shadow: 0 10px 25px rgba(106, 90, 205, 0.3);
        }
        .product-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }
        .product-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 15px 0;
            color: var(--dark);
        }
        body.dark-mode .product-name {
            color: var(--dark-text);
        }
        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .product-wholesale-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--info);
            margin: 5px 0;
        }
        .product-profit {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--success);
            margin: 5px 0;
        }
        .product-stock {
            font-size: 1.1rem;
            margin: 10px 0;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .product-stock:hover {
            background: rgba(106, 90, 205, 0.1);
        }
        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        body.dark-mode .empty-state {
            color: #a0a0a0;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .empty-state p {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .sale-steps {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            position: relative;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            max-width: 200px;
        }
        .step::before {
            content: "";
            position: absolute;
            top: 25px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--border);
            z-index: 1;
        }
        body.dark-mode .step::before {
            background: var(--dark-border);
        }
        .step:last-child::before {
            display: none;
        }
        .step.completed::before {
            background: var(--success);
        }
        .step.active::before {
            background: var(--primary);
        }
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--border);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            position: relative;
            z-index: 2;
            margin-bottom: 10px;
        }
        body.dark-mode .step-number {
            background: var(--dark-border);
        }
        .step.completed .step-number {
            background: var(--success);
        }
        .step.active .step-number {
            background: var(--primary);
        }
        .step-label {
            font-weight: 600;
            text-align: center;
            color: var(--gray);
        }
        body.dark-mode .step-label {
            color: #a0a0a0;
        }
        .step.completed .step-label,
        .step.active .step-label {
            color: var(--dark);
        }
        body.dark-mode .step.completed .step-label,
        body.dark-mode .step.active .step-label {
            color: var(--dark-text);
        }
        .sale-summary {
            background: rgba(106, 90, 205, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .sale-summary {
            background: rgba(106, 90, 205, 0.1);
            border: 2px solid rgba(106, 90, 205, 0.2);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 1.2rem;
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 1.4rem;
            border-top: 2px solid var(--primary);
            padding-top: 15px;
            margin-top: 20px;
        }
        .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        .category-item {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
        }
        body.dark-mode .category-item {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
        }
        .category-item:hover,
        .category-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .category-item .delete-category {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            display: none;
        }
        .category-item:hover .delete-category {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .expenses-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .summary-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .summary-card {
            background: var(--dark-card);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .summary-card.income {
            border-top-color: var(--income);
        }
        .summary-card.expenses {
            border-top-color: var(--expense);
        }
        .summary-card.net {
            border-top-color: var(--primary);
        }
        .summary-label {
            font-size: 1.1rem;
            color: var(--gray);
            margin-bottom: 10px;
        }
        body.dark-mode .summary-label {
            color: #a0a0a0;
        }
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        .income-value {
            color: var(--income);
        }
        .expenses-value {
            color: var(--expense);
        }
        .net-value {
            color: var(--primary);
        }
        .reorder-alert {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--danger);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        .reorder-alert h4 {
            color: var(--danger);
            margin-bottom: 10px;
        }
        .reorder-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed var(--danger);
        }
        .reorder-item:last-child {
            border-bottom: none;
        }
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .confirmation-modal.show {
            opacity: 1;
            pointer-events: all;
        }
        .confirmation-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .confirmation-content {
            background: var(--dark-card);
        }
        .confirmation-content h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        .confirmation-content p {
            margin-bottom: 25px;
            color: var(--gray);
        }
        body.dark-mode .confirmation-content p {
            color: var(--dark-text);
        }
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* إعدادات المتجر */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .settings-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        body.dark-mode .settings-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }

        .settings-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(106, 90, 205, 0.1);
        }

        .settings-card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .store-id-card {
            border-left: 4px solid var(--primary);
        }

        .sync-card {
            border-left: 4px solid var(--success);
        }

        .backup-card {
            border-left: 4px solid var(--info);
        }

        .store-id-display-settings {
            background: rgba(106, 90, 205, 0.05);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
        }

        body.dark-mode .store-id-display-settings {
            background: rgba(106, 90, 205, 0.1);
        }

        .store-id-value {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            letter-spacing: 1px;
            margin: 10px 0;
            word-break: break-all;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #5949b8;
            transform: scale(1.05);
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 10px;
            border: 1px solid var(--success);
        }

        .sync-info.offline {
            background: rgba(231, 76, 60, 0.1);
            border-color: var(--danger);
        }

        .sync-info.syncing {
            background: rgba(243, 156, 18, 0.1);
            border-color: var(--warning);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: rgba(106, 90, 205, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(106, 90, 205, 0.1);
        }

        body.dark-mode .stat-item {
            background: rgba(106, 90, 205, 0.1);
            border-color: rgba(106, 90, 205, 0.2);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        body.dark-mode .stat-label {
            color: var(--dark-text);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border: 1px solid var(--border);
        }
        body.dark-mode .toast {
            background: var(--dark-card);
            color: var(--dark-text);
            border-color: var(--dark-border);
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            border-left: 4px solid var(--success);
        }
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        .toast.info {
            border-left: 4px solid var(--info);
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            header {
                padding: 15px;
                margin-bottom: 20px;
            }
            .logo h1 {
                font-size: 1.5rem;
            }
            .logo span {
                font-size: 1rem;
            }
            .nav-tabs {
                flex-direction: column;
            }
            .tab {
                padding: 15px;
                font-size: 1rem;
            }
            .tab-content {
                padding: 20px;
            }
            .welcome-content {
                padding: 20px;
                margin: 20px;
            }
            .welcome-title {
                font-size: 2rem;
            }
            .welcome-logo {
                font-size: 3rem;
            }
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-row {
                flex-direction: column;
            }
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .action-buttons {
                justify-content: center;
            }
            .filter-bar {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة الترحيب والمزامنة -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-content">
            <div class="welcome-logo">
                <i class="fas fa-gift"></i>
            </div>
            <h1 class="welcome-title">Enjoy The Gifts</h1>
            <p class="welcome-subtitle">نظام إدارة المتاجر المتطور</p>
            
            <div id="storeSetup" class="store-setup">
                <div id="newStoreSection">
                    <p>مرحباً بك! هل تريد إنشاء متجر جديد أم ربط متجر موجود؟</p>
                    <button class="welcome-btn primary" onclick="createNewStore()">
                        <i class="fas fa-plus"></i>
                        إنشاء متجر جديد
                    </button>
                    <button class="welcome-btn" onclick="showConnectStore()">
                        <i class="fas fa-link"></i>
                        لدي معرّف متجر بالفعل
                    </button>
                </div>
                
                <div id="storeIdDisplay" class="hidden">
                    <div class="store-id-display">
                        <p><strong>معرّف متجرك الجديد:</strong></p>
                        <div id="storeIdText" class="store-id-text"></div>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                            احتفظ بهذا المعرّف لربط أجهزتك الأخرى
                        </p>
                    </div>
                    <button class="welcome-btn primary" onclick="continueToApp()">
                        <i class="fas fa-arrow-right"></i>
                        متابعة إلى التطبيق
                    </button>
                </div>
                
                <div id="connectStoreSection" class="hidden">
                    <p>أدخل معرّف المتجر الخاص بك:</p>
                    <input type="text" id="storeIdInput" class="store-input" placeholder="store_xxxxx_xxxxxxxxx">
                    <br>
                    <button class="welcome-btn primary" onclick="connectToStore()">
                        <i class="fas fa-link"></i>
                        ربط المتجر
                    </button>
                    <button class="welcome-btn" onclick="showNewStore()">
                        <i class="fas fa-arrow-right"></i>
                        رجوع
                    </button>
                </div>
                
                <div id="loadingSection" class="hidden">
                    <p>جاري التحميل والمزامنة...</p>
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- مؤشر حالة المزامنة -->
    <div id="syncStatus" class="sync-status hidden">
        <div id="syncIndicator" class="sync-indicator"></div>
        <span id="syncText">متصل</span>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <header>
                <button class="theme-toggle" onclick="toggleTheme()" title="تبديل الوضع">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-gift"></i>
                    <div>
                        <h1>Enjoy The Gifts</h1>
                        <span>نظام إدارة المتاجر المتطور</span>
                    </div>
                </div>
            </header>

            <nav class="nav-tabs">
                <div class="tab active" onclick="showTab('sales')">
                    <i class="fas fa-shopping-cart"></i>
                    المبيعات
                </div>
                <div class="tab" onclick="showTab('invoices')">
                    <i class="fas fa-file-invoice"></i>
                    الفواتير
                </div>
                <div class="tab" onclick="showTab('products')">
                    <i class="fas fa-box"></i>
                    المنتجات
                </div>
                <div class="tab" onclick="showTab('reports')">
                    <i class="fas fa-chart-bar"></i>
                    التقارير
                </div>
                <div class="tab" onclick="showTab('settings')">
                    <i class="fas fa-cog"></i>
                    الإعدادات
                </div>
            </nav>

            <!-- محتوى التبويبات -->
            <div id="sales" class="tab-content active">
                <h2 class="section-title">نقطة البيع</h2>
                
                <!-- خطوات البيع -->
                <div class="sale-steps">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-label">اختيار المنتجات</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-label">تفاصيل العميل</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-label">الدفع والإنهاء</div>
                    </div>
                </div>

                <!-- محتوى الخطوة الأولى -->
                <div id="saleStep1" class="sale-step-content">
                    <div class="action-bar">
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="addNewSaleProduct()">
                                <i class="fas fa-plus"></i>
                                إضافة منتج
                            </button>
                            <button class="btn btn-info" onclick="scanBarcode()">
                                <i class="fas fa-barcode"></i>
                                مسح الباركود
                            </button>
                        </div>
                        <div class="filter-bar">
                            <input type="text" class="form-control" placeholder="البحث عن منتج..." id="productSearch" style="max-width: 300px;">
                        </div>
                    </div>

                    <div id="saleProductsList">
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>لا توجد منتجات في السلة</h3>
                            <p>ابدأ بإضافة منتجات لإنشاء فاتورة جديدة</p>
                        </div>
                    </div>

                    <div class="sale-summary" id="saleSummary" style="display: none;">
                        <div class="summary-row">
                            <span>المجموع الفرعي:</span>
                            <span id="subtotal">0.00 ج.م</span>
                        </div>
                        <div class="summary-row">
                            <span>الخصم:</span>
                            <span id="discount">0.00 ج.م</span>
                        </div>
                        <div class="summary-row total">
                            <span>المجموع الكلي:</span>
                            <span id="total">0.00 ج.م</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary btn-block" onclick="nextStep()" id="nextStepBtn" disabled>
                            <i class="fas fa-arrow-left"></i>
                            التالي - تفاصيل العميل
                        </button>
                    </div>
                </div>

                <!-- محتوى الخطوة الثانية -->
                <div id="saleStep2" class="sale-step-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">اسم العميل</label>
                                <input type="text" class="form-control" id="customerName" placeholder="اسم العميل">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="tel" class="form-control" id="customerPhone" placeholder="رقم الهاتف">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">العنوان</label>
                        <textarea class="form-control" id="customerAddress" rows="3" placeholder="عنوان العميل"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">نوع الخصم</label>
                                <select class="form-control" id="discountType" onchange="calculateDiscount()">
                                    <option value="none">بدون خصم</option>
                                    <option value="percentage">نسبة مئوية</option>
                                    <option value="fixed">مبلغ ثابت</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">قيمة الخصم</label>
                                <input type="number" class="form-control" id="discountValue" placeholder="0" onchange="calculateDiscount()" disabled>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-info" onclick="prevStep()">
                            <i class="fas fa-arrow-right"></i>
                            السابق
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()">
                            <i class="fas fa-arrow-left"></i>
                            التالي - الدفع
                        </button>
                    </div>
                </div>

                <!-- محتوى الخطوة الثالثة -->
                <div id="saleStep3" class="sale-step-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">طريقة الدفع</label>
                                <select class="form-control" id="paymentMethod">
                                    <option value="cash">نقدي</option>
                                    <option value="card">بطاقة ائتمان</option>
                                    <option value="transfer">تحويل بنكي</option>
                                    <option value="installment">تقسيط</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">المبلغ المدفوع</label>
                                <input type="number" class="form-control" id="paidAmount" placeholder="0.00" onchange="calculateChange()">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الباقي</label>
                                <input type="number" class="form-control" id="changeAmount" placeholder="0.00" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">حالة الفاتورة</label>
                                <select class="form-control" id="invoiceStatus">
                                    <option value="completed">مكتملة</option>
                                    <option value="pending">معلقة</option>
                                    <option value="cancelled">ملغية</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="invoiceNotes" rows="3" placeholder="ملاحظات إضافية"></textarea>
                    </div>

                    <div class="sale-summary">
                        <div class="summary-row">
                            <span>المجموع الفرعي:</span>
                            <span id="finalSubtotal">0.00 ج.م</span>
                        </div>
                        <div class="summary-row">
                            <span>الخصم:</span>
                            <span id="finalDiscount">0.00 ج.م</span>
                        </div>
                        <div class="summary-row total">
                            <span>المجموع الكلي:</span>
                            <span id="finalTotal">0.00 ج.م</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-info" onclick="prevStep()">
                            <i class="fas fa-arrow-right"></i>
                            السابق
                        </button>
                        <button class="btn btn-success" onclick="completeSale()">
                            <i class="fas fa-check"></i>
                            إتمام البيع
                        </button>
                    </div>
                </div>
            </div>

            <div id="invoices" class="tab-content">
                <h2 class="section-title">إدارة الفواتير</h2>
                
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="createNewInvoice()">
                            <i class="fas fa-plus"></i>
                            فاتورة جديدة
                        </button>
                        <button class="btn btn-info" onclick="exportInvoices()">
                            <i class="fas fa-file-export"></i>
                            تصدير الفواتير
                        </button>
                    </div>
                    <div class="filter-bar">
                        <select class="form-control" id="invoiceStatusFilter" onchange="filterInvoices()" style="max-width: 200px;">
                            <option value="all">جميع الحالات</option>
                            <option value="completed">مكتملة</option>
                            <option value="pending">معلقة</option>
                            <option value="cancelled">ملغية</option>
                        </select>
                        <input type="date" class="form-control" id="invoiceDateFilter" onchange="filterInvoices()" style="max-width: 200px;">
                    </div>
                </div>

                <div class="table-container">
                    <table id="invoicesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>العميل</th>
                                <th>التاريخ</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <i class="fas fa-file-invoice"></i>
                                        <h3>لا توجد فواتير</h3>
                                        <p>ابدأ بإنشاء فاتورة جديدة</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="products" class="tab-content">
                <h2 class="section-title">إدارة المنتجات</h2>
                
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="addNewProduct()">
                            <i class="fas fa-plus"></i>
                            منتج جديد
                        </button>
                        <button class="btn btn-info" onclick="importProducts()">
                            <i class="fas fa-file-import"></i>
                            استيراد منتجات
                        </button>
                        <button class="btn btn-warning" onclick="exportProducts()">
                            <i class="fas fa-file-export"></i>
                            تصدير منتجات
                        </button>
                    </div>
                    <div class="filter-bar">
                        <input type="text" class="form-control" placeholder="البحث عن منتج..." id="productSearchFilter" onkeyup="filterProducts()" style="max-width: 300px;">
                        <select class="form-control" id="categoryFilter" onchange="filterProducts()" style="max-width: 200px;">
                            <option value="all">جميع الفئات</option>
                        </select>
                    </div>
                </div>

                <!-- قائمة الفئات -->
                <div class="category-list" id="categoryList">
                    <div class="category-item active" data-category="all">
                        جميع المنتجات
                    </div>
                </div>

                <!-- شبكة المنتجات -->
                <div class="product-grid" id="productGrid">
                    <div class="empty-state">
                        <i class="fas fa-box"></i>
                        <h3>لا توجد منتجات</h3>
                        <p>ابدأ بإضافة منتجات جديدة لمتجرك</p>
                    </div>
                </div>

                <!-- تنبيه إعادة الطلب -->
                <div class="reorder-alert" id="reorderAlert" style="display: none;">
                    <h4><i class="fas fa-exclamation-triangle"></i> منتجات تحتاج إعادة طلب</h4>
                    <div id="reorderList"></div>
                </div>
            </div>

            <div id="reports" class="tab-content">
                <h2 class="section-title">التقارير والإحصائيات</h2>
                
                <!-- ملخص الإيرادات والمصروفات -->
                <div class="expenses-summary">
                    <div class="summary-card income">
                        <div class="card-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="card-content">
                            <h3>إجمالي الإيرادات</h3>
                            <p id="totalRevenue">0.00 ج.م</p>
                        </div>
                    </div>
                    <div class="summary-card expenses">
                        <div class="card-icon">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="card-content">
                            <h3>إجمالي المصروفات</h3>
                            <p id="totalExpenses">0.00 ج.م</p>
                        </div>
                    </div>
                    <div class="summary-card net-profit">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-content">
                            <h3>صافي الربح</h3>
                            <p id="netProfit">0.00 ج.م</p>
                        </div>
                    </div>
                </div>

                <!-- فلاتر التقارير -->
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-chart-bar"></i>
                            إنشاء تقرير
                        </button>
                        <button class="btn btn-info" onclick="exportReport()">
                            <i class="fas fa-file-pdf"></i>
                            تصدير PDF
                        </button>
                    </div>
                    <div class="filter-bar">
                        <select class="form-control" id="reportPeriod" onchange="updateReports()" style="max-width: 200px;">
                            <option value="today">اليوم</option>
                            <option value="week">هذا الأسبوع</option>
                            <option value="month">هذا الشهر</option>
                            <option value="year">هذا العام</option>
                            <option value="custom">فترة مخصصة</option>
                        </select>
                        <input type="date" class="form-control" id="startDate" style="max-width: 150px;">
                        <input type="date" class="form-control" id="endDate" style="max-width: 150px;">
                    </div>
                </div>

                <!-- الرسوم البيانية -->
                <div style="margin: 30px 0;">
                    <canvas id="salesChart" width="400" height="200"></canvas>
                </div>

                <!-- جدول أفضل المنتجات -->
                <h3 style="margin: 30px 0 20px; color: var(--primary);">أفضل المنتجات مبيعاً</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>الكمية المباعة</th>
                                <th>الإيرادات</th>
                                <th>الربح</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsTable">
                            <tr>
                                <td colspan="4">
                                    <div class="empty-state">
                                        <i class="fas fa-chart-bar"></i>
                                        <h3>لا توجد بيانات</h3>
                                        <p>ابدأ بإجراء مبيعات لرؤية التقارير</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h2 class="section-title">الإعدادات</h2>
                
                <div class="settings-grid">
                    <!-- بطاقة معرف المتجر -->
                    <div class="settings-card store-id-card">
                        <h3>
                            <i class="fas fa-store"></i>
                            معرف المتجر
                        </h3>
                        <div class="store-id-display-settings">
                            <p>معرف المتجر الحالي:</p>
                            <div id="currentStoreId" class="store-id-value">غير محدد</div>
                            <button class="copy-btn" onclick="copyStoreId()">
                                <i class="fas fa-copy"></i>
                                نسخ
                            </button>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--gray); margin-top: 10px;">
                            استخدم هذا المعرف لربط أجهزتك الأخرى
                        </p>
                    </div>

                    <!-- بطاقة حالة المزامنة -->
                    <div class="settings-card sync-card">
                        <h3>
                            <i class="fas fa-sync-alt"></i>
                            حالة المزامنة
                        </h3>
                        <div id="syncInfo" class="sync-info">
                            <div id="syncStatusIcon" class="sync-indicator"></div>
                            <div>
                                <strong id="syncStatusText">متصل</strong>
                                <br>
                                <small id="syncStatusDetails">جميع البيانات محدثة</small>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="forceSyncData()">
                            <i class="fas fa-sync"></i>
                            مزامنة يدوية
                        </button>
                    </div>

                    <!-- بطاقة النسخ الاحتياطي -->
                    <div class="settings-card backup-card">
                        <h3>
                            <i class="fas fa-download"></i>
                            النسخ الاحتياطي
                        </h3>
                        <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;">
                            قم بتنزيل نسخة احتياطية من بياناتك
                        </p>
                        <button class="btn btn-info btn-sm" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            تصدير البيانات
                        </button>
                    </div>
                </div>

                <!-- إحصائيات المتجر -->
                <h3 style="margin: 30px 0 20px; color: var(--primary);">إحصائيات المتجر</h3>
                <div id="storeStats" class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalInvoices">0</div>
                        <div class="stat-label">إجمالي الفواتير</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">إجمالي المنتجات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalRevenueStats">0 ج.م</div>
                        <div class="stat-label">إجمالي الإيرادات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingChanges">0</div>
                        <div class="stat-label">التغييرات المعلقة</div>
                    </div>
                </div>

                <!-- أزرار إضافية -->
                <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="resetStore()">
                        <i class="fas fa-redo"></i>
                        إعادة تعيين المتجر
                    </button>
                    <button class="btn btn-info" onclick="connectNewStore()">
                        <i class="fas fa-link"></i>
                        ربط متجر آخر
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد -->
    <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-content">
            <h3 id="confirmationTitle">تأكيد العملية</h3>
            <p id="confirmationMessage">هل أنت متأكد من هذا الإجراء؟</p>
            <div class="confirmation-buttons">
                <button class="btn btn-danger" id="confirmBtn">تأكيد</button>
                <button class="btn btn-info" onclick="hideConfirmation()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- تحميل database.js -->
    <script src="database.js"></script>
    
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <script>
        // متغيرات عامة
        let currentTheme = 'light';
        let currentTab = 'sales';
        let currentStep = 1;
        let saleProducts = [];
        let allProducts = [];
        let allInvoices = [];
        let categories = [];
        let saleSubtotal = 0;
        let saleDiscount = 0;
        let saleTotal = 0;

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
        });

        // تهيئة التطبيق
        async function initializeApp() {
            try {
                console.log('Initializing app...');
                
                // التأكد من وجود invoiceDB
                if (typeof window.invoiceDB === 'undefined') {
                    throw new Error('invoiceDB is not defined');
                }
                
                // تهيئة قاعدة البيانات
                await window.invoiceDB.init();
                console.log('Database initialized');
                
                // فحص حالة المتجر
                const syncStatus = window.invoiceDB.getSyncStatus();
                console.log('Sync status:', syncStatus);
                
                if (!syncStatus.hasStoreId) {
                    // عرض شاشة الترحيب
                    showWelcomeScreen();
                } else {
                    // إخفاء شاشة الترحيب وعرض التطبيق
                    hideWelcomeScreen();
                    await loadAppData();
                }
                
                // تحديث مؤشر المزامنة
                updateSyncStatus();
                
                // مراقبة حالة الاتصال
                window.addEventListener('online', updateSyncStatus);
                window.addEventListener('offline', updateSyncStatus);
                
                // تحميل الإعدادات المحفوظة
                loadSavedSettings();
                
            } catch (error) {
                console.error('خطأ في تهيئة التطبيق:', error);
                showToast('خطأ في تهيئة التطبيق: ' + error.message, 'error');
            }
        }

        // عرض شاشة الترحيب
        function showWelcomeScreen() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('syncStatus').classList.add('hidden');
        }

        // إخفاء شاشة الترحيب
        function hideWelcomeScreen() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('syncStatus').classList.remove('hidden');
        }

        // إنشاء متجر جديد
        async function createNewStore() {
            showLoading();
            
            try {
                console.log('Creating new store...');
                const storeId = await window.invoiceDB.createNewStore();
                console.log('Store created:', storeId);
                
                document.getElementById('newStoreSection').classList.add('hidden');
                document.getElementById('storeIdDisplay').classList.remove('hidden');
                document.getElementById('storeIdText').textContent = storeId;
                
                hideLoading();
                showToast('تم إنشاء المتجر بنجاح!', 'success');
                
            } catch (error) {
                console.error('خطأ في إنشاء المتجر:', error);
                hideLoading();
                showToast('خطأ في إنشاء المتجر: ' + error.message, 'error');
            }
        }

        // عرض قسم ربط المتجر
        function showConnectStore() {
            document.getElementById('newStoreSection').classList.add('hidden');
            document.getElementById('connectStoreSection').classList.remove('hidden');
        }

        // عرض قسم المتجر الجديد
        function showNewStore() {
            document.getElementById('connectStoreSection').classList.add('hidden');
            document.getElementById('newStoreSection').classList.remove('hidden');
        }

        // ربط متجر موجود
        async function connectToStore() {
            const storeId = document.getElementById('storeIdInput').value.trim();
            
            if (!storeId) {
                showToast('يرجى إدخال معرّف المتجر', 'warning');
                return;
            }
            
            showLoading();
            
            try {
                await window.invoiceDB.connectToStore(storeId);
                hideLoading();
                continueToApp();
                showToast('تم ربط المتجر بنجاح!', 'success');
                
            } catch (error) {
                console.error('خطأ في ربط المتجر:', error);
                hideLoading();
                showToast('خطأ في ربط المتجر: ' + error.message, 'error');
            }
        }

        // المتابعة إلى التطبيق
        async function continueToApp() {
            hideWelcomeScreen();
            await loadAppData();
        }

        // عرض شاشة التحميل
        function showLoading() {
            document.getElementById('newStoreSection').classList.add('hidden');
            document.getElementById('connectStoreSection').classList.add('hidden');
            document.getElementById('storeIdDisplay').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
        }

        // إخفاء شاشة التحميل
        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }

        // تحديث مؤشر المزامنة
        function updateSyncStatus() {
            if (!window.invoiceDB) return;
            
            const syncStatus = window.invoiceDB.getSyncStatus();
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            
            // تحديث مؤشر الزاوية العلوية
            if (syncStatus.isOnline && syncStatus.firebaseInitialized) {
                indicator.className = 'sync-indicator';
                text.textContent = 'متصل';
            } else if (syncStatus.isOnline && !syncStatus.firebaseInitialized) {
                indicator.className = 'sync-indicator syncing';
                text.textContent = 'يتم الاتصال...';
            } else {
                indicator.className = 'sync-indicator offline';
                text.textContent = 'غير متصل';
            }

            // تحديث مؤشر الإعدادات
            const syncInfo = document.getElementById('syncInfo');
            const syncStatusIcon = document.getElementById('syncStatusIcon');
            const syncStatusText = document.getElementById('syncStatusText');
            const syncStatusDetails = document.getElementById('syncStatusDetails');

            if (syncInfo) {
                if (syncStatus.isOnline && syncStatus.firebaseInitialized) {
                    syncInfo.className = 'sync-info';
                    syncStatusIcon.className = 'sync-indicator';
                    syncStatusText.textContent = 'متصل';
                    syncStatusDetails.textContent = 'جميع البيانات محدثة';
                } else if (syncStatus.isOnline && !syncStatus.firebaseInitialized) {
                    syncInfo.className = 'sync-info syncing';
                    syncStatusIcon.className = 'sync-indicator syncing';
                    syncStatusText.textContent = 'يتم الاتصال...';
                    syncStatusDetails.textContent = 'جاري تهيئة الاتصال';
                } else {
                    syncInfo.className = 'sync-info offline';
                    syncStatusIcon.className = 'sync-indicator offline';
                    syncStatusText.textContent = 'غير متصل';
                    syncStatusDetails.textContent = 'العمل في وضع عدم الاتصال';
                }
            }
        }

        // تحميل بيانات التطبيق
        async function loadAppData() {
            try {
                // تحديث معرف المتجر في الإعدادات
                const syncStatus = window.invoiceDB.getSyncStatus();
                if (syncStatus.storeId) {
                    document.getElementById('currentStoreId').textContent = syncStatus.storeId;
                }
                
                // تحميل البيانات
                await loadProducts();
                await loadInvoices();
                await loadCategories();
                
                // تحديث الإحصائيات
                await updateStoreStats();
                await updateReports();
                
                // مزامنة التغييرات المعلقة
                if (navigator.onLine) {
                    await window.invoiceDB.syncPendingChanges();
                }
                
                console.log('App data loaded successfully');
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showToast('خطأ في تحميل البيانات: ' + error.message, 'error');
            }
        }

        // تحميل المنتجات
        async function loadProducts() {
            try {
                allProducts = await window.invoiceDB.getAllProducts() || [];
                renderProducts();
                updateProductFilters();
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                allProducts = [];
            }
        }

        // تحميل الفواتير
        async function loadInvoices() {
            try {
                allInvoices = await window.invoiceDB.getAllInvoices() || [];
                renderInvoices();
            } catch (error) {
                console.error('خطأ في تحميل الفواتير:', error);
                allInvoices = [];
            }
        }

        // تحميل الفئات
        async function loadCategories() {
            try {
                categories = await window.invoiceDB.getAllCategories() || [];
                renderCategories();
            } catch (error) {
                console.error('خطأ في تحميل الفئات:', error);
                categories = [];
            }
        }

        // عرض المنتجات
        function renderProducts() {
            const productGrid = document.getElementById('productGrid');
            
            if (allProducts.length === 0) {
                productGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box"></i>
                        <h3>لا توجد منتجات</h3>
                        <p>ابدأ بإضافة منتجات جديدة لمتجرك</p>
                    </div>
                `;
                return;
            }

            productGrid.innerHTML = allProducts.map(product => `
                <div class="product-card" data-category="${product.category}">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${product.price.toFixed(2)} ج.م</div>
                    <div class="product-wholesale-price">سعر الجملة: ${product.wholesalePrice.toFixed(2)} ج.م</div>
                    <div class="product-profit">الربح: ${(product.price - product.wholesalePrice).toFixed(2)} ج.م</div>
                    <div class="product-stock ${getStockStatus(product.stock)}" onclick="updateStock(${product.id})">
                        المخزون: ${product.stock}
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="addToSale(${product.id})">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // تحديث تنبيه إعادة الطلب
            updateReorderAlert();
        }

        // عرض الفواتير
        function renderInvoices() {
            const tableBody = document.getElementById('invoicesTableBody');
            
            if (allInvoices.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-file-invoice"></i>
                                <h3>لا توجد فواتير</h3>
                                <p>ابدأ بإنشاء فاتورة جديدة</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = allInvoices.map(invoice => `
                <tr>
                    <td>${invoice.id}</td>
                    <td>${invoice.customerName || 'عميل غير محدد'}</td>
                    <td>${new Date(invoice.date).toLocaleDateString('ar-EG')}</td>
                    <td>${invoice.total.toFixed(2)} ج.م</td>
                    <td><span class="status status-${invoice.status}">${getStatusText(invoice.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewInvoice(${invoice.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="printInvoice(${invoice.id})">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // عرض الفئات
        function renderCategories() {
            const categoryList = document.getElementById('categoryList');
            const categoryFilter = document.getElementById('categoryFilter');
            
            // تحديث قائمة الفئات
            const categoryItems = categories.map(category => `
                <div class="category-item" data-category="${category.id}" onclick="filterByCategory('${category.id}')">
                    ${category.name}
                    <button class="delete-category" onclick="deleteCategory('${category.id}')">×</button>
                </div>
            `).join('');
            
            categoryList.innerHTML = `
                <div class="category-item active" data-category="all" onclick="filterByCategory('all')">
                    جميع المنتجات
                </div>
                ${categoryItems}
                <div class="category-item" onclick="addNewCategory()">
                    <i class="fas fa-plus"></i> إضافة فئة
                </div>
            `;

            // تحديث فلتر الفئات
            const categoryOptions = categories.map(category => 
                `<option value="${category.id}">${category.name}</option>`
            ).join('');
            
            categoryFilter.innerHTML = `
                <option value="all">جميع الفئات</option>
                ${categoryOptions}
            `;
        }

        // تحديث إحصائيات المتجر
        async function updateStoreStats() {
            try {
                const stats = await window.invoiceDB.getStatistics();
                
                document.getElementById('totalInvoices').textContent = stats.totalInvoices;
                document.getElementById('totalProducts').textContent = stats.totalProducts;
                document.getElementById('totalRevenueStats').textContent = stats.totalRevenue.toLocaleString() + ' ج.م';
                document.getElementById('pendingChanges').textContent = stats.pendingChanges;
                
            } catch (error) {
                console.error('خطأ في تحديث الإحصائيات:', error);
            }
        }

        // تحديث التقارير
        async function updateReports() {
            try {
                const period = document.getElementById('reportPeriod').value;
                const reports = await window.invoiceDB.getReports(period);
                
                document.getElementById('totalRevenue').textContent = reports.totalRevenue.toFixed(2) + ' ج.م';
                document.getElementById('totalExpenses').textContent = reports.totalExpenses.toFixed(2) + ' ج.م';
                document.getElementById('netProfit').textContent = reports.netProfit.toFixed(2) + ' ج.م';
                
                // تحديث جدول أفضل المنتجات
                updateTopProductsTable(reports.topProducts);
                
            } catch (error) {
                console.error('خطأ في تحديث التقارير:', error);
            }
        }

        // تبديل التبويبات
        function showTab(tabName) {
            // إخفاء جميع التبويبات
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            // عرض التبويب المحدد
            event.target.closest('.tab').classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            // تحديث البيانات حسب التبويب
            if (tabName === 'settings') {
                updateStoreStats();
            } else if (tabName === 'reports') {
                updateReports();
            }
        }

        // وظائف نقطة البيع
        function nextStep() {
            if (currentStep < 3) {
                // إخفاء الخطوة الحالية
                document.getElementById(`saleStep${currentStep}`).style.display = 'none';
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.getElementById(`step${currentStep}`).classList.add('completed');
                
                // عرض الخطوة التالية
                currentStep++;
                document.getElementById(`saleStep${currentStep}`).style.display = 'block';
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                // تحديث الملخص في الخطوة الأخيرة
                if (currentStep === 3) {
                    updateFinalSummary();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                // إخفاء الخطوة الحالية
                document.getElementById(`saleStep${currentStep}`).style.display = 'none';
                document.getElementById(`step${currentStep}`).classList.remove('active');
                
                // عرض الخطوة السابقة
                currentStep--;
                document.getElementById(`saleStep${currentStep}`).style.display = 'block';
                document.getElementById(`step${currentStep}`).classList.add('active');
                document.getElementById(`step${currentStep}`).classList.remove('completed');
            }
        }

        // إضافة منتج للبيع
        function addToSale(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            // التحقق من وجود المنتج في السلة
            const existingItem = saleProducts.find(item => item.productId === productId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                saleProducts.push({
                    productId: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    total: product.price
                });
            }
            
            updateSaleDisplay();
            showToast('تم إضافة المنتج للسلة', 'success');
        }

        // تحديث عرض البيع
        function updateSaleDisplay() {
            const saleProductsList = document.getElementById('saleProductsList');
            const saleSummary = document.getElementById('saleSummary');
            const nextStepBtn = document.getElementById('nextStepBtn');
            
            if (saleProducts.length === 0) {
                saleProductsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>لا توجد منتجات في السلة</h3>
                        <p>ابدأ بإضافة منتجات لإنشاء فاتورة جديدة</p>
                    </div>
                `;
                saleSummary.style.display = 'none';
                nextStepBtn.disabled = true;
                return;
            }
            
            // عرض المنتجات
            saleProductsList.innerHTML = saleProducts.map((item, index) => `
                <div class="sale-product-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${item.name}</h4>
                            <p>السعر: ${item.price.toFixed(2)} ج.م</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn btn-sm btn-info" onclick="decreaseQuantity(${index})">-</button>
                            <span style="font-weight: bold; font-size: 1.2rem;">${item.quantity}</span>
                            <button class="btn btn-sm btn-info" onclick="increaseQuantity(${index})">+</button>
                            <span style="font-weight: bold; color: var(--primary);">${item.total.toFixed(2)} ج.م</span>
                            <button class="btn btn-sm btn-danger" onclick="removeFromSale(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // حساب المجاميع
            calculateSaleTotals();
            
            // عرض الملخص
            saleSummary.style.display = 'block';
            document.getElementById('subtotal').textContent = saleSubtotal.toFixed(2) + ' ج.م';
            document.getElementById('discount').textContent = saleDiscount.toFixed(2) + ' ج.م';
            document.getElementById('total').textContent = saleTotal.toFixed(2) + ' ج.م';
            
            nextStepBtn.disabled = false;
        }

        // حساب مجاميع البيع
        function calculateSaleTotals() {
            saleSubtotal = saleProducts.reduce((sum, item) => {
                item.total = item.price * item.quantity;
                return sum + item.total;
            }, 0);
            
            // حساب الخصم
            const discountType = document.getElementById('discountType')?.value || 'none';
            const discountValue = parseFloat(document.getElementById('discountValue')?.value || 0);
            
            if (discountType === 'percentage') {
                saleDiscount = (saleSubtotal * discountValue) / 100;
            } else if (discountType === 'fixed') {
                saleDiscount = discountValue;
            } else {
                saleDiscount = 0;
            }
            
            saleTotal = saleSubtotal - saleDiscount;
        }

        // زيادة الكمية
        function increaseQuantity(index) {
            saleProducts[index].quantity++;
            updateSaleDisplay();
        }

        // تقليل الكمية
        function decreaseQuantity(index) {
            if (saleProducts[index].quantity > 1) {
                saleProducts[index].quantity--;
                updateSaleDisplay();
            }
        }

        // إزالة من البيع
        function removeFromSale(index) {
            saleProducts.splice(index, 1);
            updateSaleDisplay();
        }

        // حساب الخصم
        function calculateDiscount() {
            const discountType = document.getElementById('discountType').value;
            const discountInput = document.getElementById('discountValue');
            
            if (discountType === 'none') {
                discountInput.disabled = true;
                discountInput.value = 0;
            } else {
                discountInput.disabled = false;
            }
            
            calculateSaleTotals();
            updateSaleDisplay();
        }

        // تحديث الملخص النهائي
        function updateFinalSummary() {
            document.getElementById('finalSubtotal').textContent = saleSubtotal.toFixed(2) + ' ج.م';
            document.getElementById('finalDiscount').textContent = saleDiscount.toFixed(2) + ' ج.م';
            document.getElementById('finalTotal').textContent = saleTotal.toFixed(2) + ' ج.م';
            
            // تعيين المبلغ المدفوع افتراضياً
            document.getElementById('paidAmount').value = saleTotal.toFixed(2);
            calculateChange();
        }

        // حساب الباقي
        function calculateChange() {
            const paidAmount = parseFloat(document.getElementById('paidAmount').value || 0);
            const change = paidAmount - saleTotal;
            document.getElementById('changeAmount').value = change.toFixed(2);
        }

        // إتمام البيع
        async function completeSale() {
            try {
                const customerName = document.getElementById('customerName').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paidAmount = parseFloat(document.getElementById('paidAmount').value || 0);
                const invoiceStatus = document.getElementById('invoiceStatus').value;
                const notes = document.getElementById('invoiceNotes').value;
                
                const invoice = {
                    customerName,
                    customerPhone,
                    customerAddress,
                    paymentMethod,
                    paidAmount,
                    status: invoiceStatus,
                    notes,
                    products: saleProducts,
                    subtotal: saleSubtotal,
                    discount: saleDiscount,
                    total: saleTotal,
                    date: new Date().toISOString()
                };
                
                await window.invoiceDB.addInvoice(invoice);
                
                // تحديث المخزون
                for (const item of saleProducts) {
                    const product = allProducts.find(p => p.id === item.productId);
                    if (product) {
                        product.stock -= item.quantity;
                        await window.invoiceDB.updateProduct(product);
                    }
                }
                
                showToast('تم إتمام البيع بنجاح!', 'success');
                
                // إعادة تعيين البيع
                resetSale();
                
                // تحديث البيانات
                await loadInvoices();
                await loadProducts();
                await updateStoreStats();
                
            } catch (error) {
                console.error('خطأ في إتمام البيع:', error);
                showToast('خطأ في إتمام البيع: ' + error.message, 'error');
            }
        }

        // إعادة تعيين البيع
        function resetSale() {
            saleProducts = [];
            currentStep = 1;
            saleSubtotal = 0;
            saleDiscount = 0;
            saleTotal = 0;
            
            // إعادة تعيين الخطوات
            document.getElementById('saleStep1').style.display = 'block';
            document.getElementById('saleStep2').style.display = 'none';
            document.getElementById('saleStep3').style.display = 'none';
            
            document.getElementById('step1').className = 'step active';
            document.getElementById('step2').className = 'step';
            document.getElementById('step3').className = 'step';
            
            // مسح النماذج
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('discountType').value = 'none';
            document.getElementById('discountValue').value = 0;
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('paidAmount').value = '';
            document.getElementById('invoiceStatus').value = 'completed';
            document.getElementById('invoiceNotes').value = '';
            
            updateSaleDisplay();
        }

        // وظائف مساعدة
        function getStockStatus(stock) {
            if (stock <= 0) return 'status-out-of-stock';
            if (stock <= 10) return 'status-low-stock';
            return 'status-in-stock';
        }

        function getStatusText(status) {
            const statusMap = {
                'completed': 'مكتملة',
                'pending': 'معلقة',
                'cancelled': 'ملغية',
                'in-progress': 'قيد التنفيذ'
            };
            return statusMap[status] || status;
        }

        // نسخ معرف المتجر
        function copyStoreId() {
            const storeId = document.getElementById('currentStoreId').textContent;
            if (storeId && storeId !== 'غير محدد') {
                navigator.clipboard.writeText(storeId).then(() => {
                    showToast('تم نسخ معرف المتجر', 'success');
                }).catch(() => {
                    showToast('فشل في نسخ معرف المتجر', 'error');
                });
            }
        }

        // مزامنة يدوية
        async function forceSyncData() {
            try {
                showToast('جاري المزامنة...', 'info');
                await window.invoiceDB.syncPendingChanges();
                await updateStoreStats();
                showToast('تمت المزامنة بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في المزامنة:', error);
                showToast('فشل في المزامنة', 'error');
            }
        }

        // تصدير البيانات
        async function exportData() {
            try {
                const stats = await window.invoiceDB.getStatistics();
                const invoices = await window.invoiceDB.getAllInvoices();
                const products = await window.invoiceDB.getAllProducts();
                
                const exportData = {
                    storeId: stats.storeId,
                    exportDate: new Date().toISOString(),
                    statistics: stats,
                    invoices: invoices,
                    products: products
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `enjoy-gifts-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showToast('تم تصدير البيانات بنجاح', 'success');
                
            } catch (error) {
                console.error('خطأ في تصدير البيانات:', error);
                showToast('فشل في تصدير البيانات', 'error');
            }
        }

        // إعادة تعيين المتجر
        function resetStore() {
            if (confirm('هل أنت متأكد من إعادة تعيين المتجر؟ سيتم حذف جميع البيانات المحلية.')) {
                localStorage.removeItem('storeId');
                localStorage.removeItem('theme');
                location.reload();
            }
        }

        // ربط متجر آخر
        function connectNewStore() {
            if (confirm('هل تريد ربط متجر آخر؟ سيتم فقدان البيانات المحلية الحالية.')) {
                localStorage.removeItem('storeId');
                location.reload();
            }
        }

        // تبديل الوضع الليلي/النهاري
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.classList.toggle('dark-mode');
            
            const themeIcon = document.getElementById('themeIcon');
            if (currentTheme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
            
            localStorage.setItem('theme', currentTheme);
        }

        // عرض رسالة منبثقة
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // تحميل الإعدادات المحفوظة
        function loadSavedSettings() {
            // تحميل الوضع المحفوظ
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                toggleTheme();
            }
        }

        // وظائف إضافية (ستحتاج للتنفيذ)
        function addNewSaleProduct() {
            showToast('ميزة إضافة منتج جديد قيد التطوير', 'info');
        }

        function scanBarcode() {
            showToast('ميزة مسح الباركود قيد التطوير', 'info');
        }

        function addNewProduct() {
            showToast('ميزة إضافة منتج جديد قيد التطوير', 'info');
        }

        function editProduct(id) {
            showToast('ميزة تعديل المنتج قيد التطوير', 'info');
        }

        function deleteProduct(id) {
            showToast('ميزة حذف المنتج قيد التطوير', 'info');
        }

        function updateStock(id) {
            showToast('ميزة تحديث المخزون قيد التطوير', 'info');
        }

        function filterProducts() {
            showToast('ميزة فلترة المنتجات قيد التطوير', 'info');
        }

        function filterByCategory(category) {
            showToast('ميزة فلترة حسب الفئة قيد التطوير', 'info');
        }

        function addNewCategory() {
            showToast('ميزة إضافة فئة جديدة قيد التطوير', 'info');
        }

        function deleteCategory(id) {
            showToast('ميزة حذف الفئة قيد التطوير', 'info');
        }

        function createNewInvoice() {
            showTab('sales');
        }

        function exportInvoices() {
            showToast('ميزة تصدير الفواتير قيد التطوير', 'info');
        }

        function filterInvoices() {
            showToast('ميزة فلترة الفواتير قيد التطوير', 'info');
        }

        function viewInvoice(id) {
            showToast('ميزة عرض الفاتورة قيد التطوير', 'info');
        }

        function printInvoice(id) {
            showToast('ميزة طباعة الفاتورة قيد التطوير', 'info');
        }

        function deleteInvoice(id) {
            showToast('ميزة حذف الفاتورة قيد التطوير', 'info');
        }

        function importProducts() {
            showToast('ميزة استيراد المنتجات قيد التطوير', 'info');
        }

        function exportProducts() {
            showToast('ميزة تصدير المنتجات قيد التطوير', 'info');
        }

        function generateReport() {
            showToast('ميزة إنشاء التقرير قيد التطوير', 'info');
        }

        function exportReport() {
            showToast('ميزة تصدير التقرير قيد التطوير', 'info');
        }

        function updateProductFilters() {
            // تحديث فلاتر المنتجات
        }

        function updateReorderAlert() {
            // تحديث تنبيه إعادة الطلب
        }

        function updateTopProductsTable(topProducts) {
            // تحديث جدول أفضل المنتجات
        }

        function hideConfirmation() {
            document.getElementById('confirmationModal').classList.remove('show');
        }
        
    </script>
</body>
</html>

