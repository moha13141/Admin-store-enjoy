<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="نظام متكامل لإدارة المبيعات والمخزون والفواتير - Enjoy The Gifts">
    <meta name="keywords" content="فواتير, مبيعات, مخزون, إدارة, متجر, تجارة">
    <meta name="author" content="Enjoy The Gifts">
    <meta name="theme-color" content="#6a5acd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Enjoy Gifts">
    <meta name="msapplication-TileColor" content="#6a5acd">
    <meta name="msapplication-TileImage" content="./app-icon.jpg">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/jpeg" href="./app-icon.jpg">
    <link rel="apple-touch-icon" href="./app-icon.jpg">
    <title>Enjoy The Gifts-Store system</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="database.js"></script>
    <style>
        :root {
            /* ألوان الوضع النهاري */
            --primary: #6a5acd;
            --primary-light: #8a7cff;
            --secondary: #9370db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --light-bg: #f8f9ff;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --gray: #7f8c8d;
            --card-bg: #ffffff;
            --card-shadow: rgba(99, 99, 99, 0.15) 0px 2px 8px 0px;
            --border: #e0e0e0;
            --expense: #e74c3c;
            --expense-light: rgba(231, 76, 60, 0.1);
            --income: #2ecc71;
            --income-light: rgba(46, 204, 113, 0.1);
            /* ألوان الوضع الليلي */
            --dark-bg: #121212;
            --dark-card: #1e1e1e;
            --dark-text: #e0e0e0;
            --dark-border: #333333;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            transition: background-color 0.4s, color 0.3s, border-color 0.4s;
        }
        body {
            background: var(--light-bg);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        body[dir="ltr"] {
            direction: ltr;
            text-align: left;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body[dir="ltr"] .nav-tabs {
            direction: ltr;
        }
        body[dir="ltr"] .form-row {
            flex-direction: row-reverse;
        }
        body[dir="ltr"] .step {
            text-align: left;
        }
        body[dir="ltr"] .step::before {
            right: auto;
            left: 0;
        }
        body[dir="ltr"] .step::after {
            right: auto;
            left: 0;
        }
        body[dir="ltr"] .sale-product-item::before {
            right: auto;
            left: 0;
            border-radius: 12px 0 0 12px;
        }
        body[dir="ltr"] .product-grid {
            text-align: left;
        }
        body[dir="ltr"] .category-list {
            justify-content: flex-start;
        }
        body[dir="ltr"] .category-item {
            direction: ltr;
            text-align: left;
        }
        body[dir="ltr"] .summary-row {
            justify-content: space-between;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            animation: headerGlow 3s infinite alternate;
        }
        @keyframes headerGlow {
            0% { box-shadow: var(--card-shadow); }
            100% { box-shadow: 0 0 20px rgba(106, 90, 205, 0.3), var(--card-shadow); }
        }
        body.dark-mode header {
            background: linear-gradient(90deg, #2c2250, #3a2a6c);
        }
        header::before {
            content: "";
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        header::after {
            content: "";
            position: absolute;
            bottom: -30px;
            left: -30px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2;
            animation: fadeInUp 0.5s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .logo i {
            font-size: 2.5rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
        }
        .logo span {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 100;
        }
        body.dark-mode .theme-toggle {
            color: var(--dark-text);
        }
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg);
        }
        .theme-toggle:active {
            transform: scale(0.9);
        }
        .lang-toggle {
            position: absolute;
            top: 20px;
            left: 70px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            font-size: 1.1rem;
            transition: all 0.3s ease;
            z-index: 100;
        }
        body.dark-mode .lang-toggle {
            color: var(--dark-text);
        }
        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(-15deg);
        }
        .lang-toggle:active {
            transform: scale(0.9);
        }
        
        /* Online/Offline Status Indicator */
        .online-status {
            position: fixed;
            top: 80px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .online-status.online {
            background: rgba(46, 204, 113, 0.9);
            color: white;
            box-shadow: 0 2px 10px rgba(46, 204, 113, 0.3);
        }
        
        .online-status.offline {
            background: rgba(231, 76, 60, 0.9);
            color: white;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }
        
        /* PWA Install Button */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 0;
            }
            
            .header {
                padding: 10px;
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                text-align: center;
            }
            
            .header-controls {
                justify-content: center;
                gap: 10px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
                padding: 10px;
            }
            
            .tab {
                flex: 1;
                min-width: calc(50% - 5px);
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .tab i {
                display: block;
                margin-bottom: 4px;
                font-size: 1.2rem;
            }
            
            .action-bar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .filter-bar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .filter-bar input,
            .filter-bar select,
            .filter-bar button {
                width: 100%;
                margin: 0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 1rem;
                min-height: 44px; /* Touch-friendly size */
            }
            
            .btn-sm {
                padding: 8px 12px;
                font-size: 0.9rem;
                min-height: 36px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 0.9rem;
            }
            
            .summary-cards {
                flex-direction: column;
                gap: 15px;
            }
            
            .summary-card {
                padding: 15px;
            }
            
            .expenses-summary {
                flex-direction: column;
                gap: 15px;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .product-card {
                padding: 15px;
            }
            
            .selected-products {
                max-height: 300px;
            }
            
            .notification {
                left: 10px;
                right: 10px;
                width: auto;
                font-size: 0.9rem;
            }
            
            .online-status {
                top: 70px;
                left: 10px;
                font-size: 0.8rem;
                padding: 6px 10px;
            }
            
            .install-button {
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto;
            }
            
            /* Modal adjustments for mobile */
            .confirmation-modal {
                padding: 20px;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
                max-width: calc(100vw - 40px);
            }
            
            /* Form improvements for mobile */
            .form-control {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                border-radius: 8px;
            }
            
            .form-label {
                font-size: 1rem;
                margin-bottom: 8px;
            }
            
            /* Touch-friendly improvements */
            .product-card:hover {
                transform: none; /* Disable hover effects on touch devices */
            }
            
            .btn:hover {
                transform: none;
            }
            
            /* Improve scrolling on mobile */
            .tab-content {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Better spacing for mobile */
            .section-title {
                font-size: 1.3rem;
                margin-bottom: 20px;
            }
            
            .empty-state {
                padding: 30px 20px;
            }
            
            .empty-state h3 {
                font-size: 1.1rem;
            }
            
            .empty-state p {
                font-size: 0.9rem;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }
            
            .tab {
                min-width: 100%;
                margin-bottom: 5px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .summary-card {
                padding: 12px;
            }
            
            .summary-value {
                font-size: 1.3rem;
            }
            
            .btn {
                font-size: 0.9rem;
                padding: 10px 14px;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            .form-control {
                font-size: 16px;
                padding: 10px;
            }
        }
        
        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: 8px 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .nav-tabs {
                padding: 8px;
            }
            
            .tab {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .online-status {
                top: 60px;
            }
        }
        
        /* Touch device specific styles */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover,
            .tab:hover,
            .product-card:hover {
                transform: none;
                box-shadow: none;
            }
            
            .btn:active,
            .tab:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            /* Larger touch targets */
            .btn,
            .tab,
            input,
            select,
            textarea {
                min-height: 44px;
            }
            
            /* Remove hover effects */
            .product-card:hover {
                background: var(--card-bg);
                border-color: var(--border);
            }
        }
        
        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .header h1 {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            position: relative;
            z-index: 10;
        }
        body.dark-mode .nav-tabs {
            background: var(--dark-card);
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            font-size: 1.1rem;
            position: relative;
        }
        body.dark-mode .tab {
            color: var(--dark-text);
        }
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: rgba(106, 90, 205, 0.05);
        }
        body.dark-mode .tab.active {
            background: rgba(106, 90, 205, 0.1);
        }
        .tab:hover:not(.active) {
            background: rgba(106, 90, 205, 0.08);
        }
        body.dark-mode .tab:hover:not(.active) {
            background: rgba(106, 90, 205, 0.15);
        }
        .tab i {
            margin-left: 8px;
        }
        .tab-content {
            display: none;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            animation: fadeIn 0.5s;
            border: 1px solid rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .tab-content {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section-title {
            font-size: 1.8rem;
            margin: 0 0 25px;
            color: var(--primary);
            position: relative;
            padding-bottom: 15px;
            font-weight: 700;
        }
        body.dark-mode .section-title {
            color: var(--primary-light);
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 80px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }
        body[dir="ltr"] .section-title::after {
            right: auto;
            left: 0;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }
        body.dark-mode .form-label {
            color: var(--dark-text);
        }
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
        }
        body.dark-mode .form-control {
            background: #2a2a2a;
            border: 2px solid var(--dark-border);
            color: var(--dark-text);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2);
        }
        body.dark-mode .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.4);
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #5949b8;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(106, 90, 205, 0.3);
        }
        body.dark-mode .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(106, 90, 205, 0.5);
        }
        .btn-sm {
            padding: 10px 20px;
            font-size: 1rem;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-info {
            background: var(--info);
            color: white;
        }
        .btn-block {
            display: block;
            width: 100%;
        }
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin: 25px 0;
            background: white;
            border: 1px solid var(--border);
        }
        body.dark-mode .table-container {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            min-width: 800px;
        }
        body.dark-mode table {
            background: var(--dark-card);
        }
        th, td {
            padding: 18px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            font-size: 1.1rem;
        }
        body.dark-mode th, 
        body.dark-mode td {
            border-bottom: 1px solid var(--dark-border);
            color: var(--dark-text);
        }
        th {
            font-weight: 700;
            background: rgba(106, 90, 205, 0.05);
        }
        body.dark-mode th {
            background: rgba(106, 90, 205, 0.1);
        }
        thead {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
        }
        body.dark-mode thead {
            background: linear-gradient(90deg, #2c2250, #3a2a6c);
        }
        tbody tr:hover {
            background: rgba(106, 90, 205, 0.03);
        }
        body.dark-mode tbody tr:hover {
            background: rgba(106, 90, 205, 0.1);
        }
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            display: inline-block;
        }
        .status-in-stock {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
        }
        .status-low-stock {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        .status-out-of-stock {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }
        .status-pending {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
            cursor: pointer;
        }
        .status-in-progress {
            background: rgba(52, 152, 219, 0.15);
            color: var(--info);
            cursor: pointer;
        }
        .status-completed {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
            cursor: pointer;
        }
        .status-cancelled {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            cursor: pointer;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-col {
            flex: 1;
        }
        .sale-product-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
        }
        .sale-product-item:hover {
            box-shadow: 0 5px 15px rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .sale-product-item {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }
        .sale-product-item::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            border-radius: 0 12px 12px 0;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            border: 1px solid var(--border);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        body.dark-mode .product-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .product-card:hover {
            box-shadow: 0 10px 25px rgba(106, 90, 205, 0.3);
        }
        .product-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }
        .product-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 15px 0;
            color: var(--dark);
        }
        body.dark-mode .product-name {
            color: var(--dark-text);
        }
        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .product-wholesale-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--info);
            margin: 5px 0;
        }
        .product-profit {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--success);
            margin: 5px 0;
        }
        .product-stock {
            font-size: 1.1rem;
            margin: 10px 0;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .product-stock:hover {
            background: rgba(106, 90, 205, 0.1);
        }
        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        body.dark-mode .empty-state {
            color: #a0a0a0;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .empty-state p {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .sale-steps {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            position: relative;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            max-width: 200px;
        }
        .step::before {
            content: "";
            position: absolute;
            top: 25px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--border);
            z-index: 1;
        }
        body.dark-mode .step::before {
            background: var(--dark-border);
        }
        .step:last-child::before {
            display: none;
        }
        .step.completed::before {
            background: var(--success);
        }
        .step.active::before {
            background: var(--primary);
        }
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--border);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            position: relative;
            z-index: 2;
            margin-bottom: 10px;
        }
        body.dark-mode .step-number {
            background: var(--dark-border);
        }
        .step.completed .step-number {
            background: var(--success);
        }
        .step.active .step-number {
            background: var(--primary);
        }
        .step-label {
            font-weight: 600;
            text-align: center;
            color: var(--gray);
        }
        body.dark-mode .step-label {
            color: #a0a0a0;
        }
        .step.completed .step-label,
        .step.active .step-label {
            color: var(--dark);
        }
        body.dark-mode .step.completed .step-label,
        body.dark-mode .step.active .step-label {
            color: var(--dark-text);
        }
        .sale-summary {
            background: rgba(106, 90, 205, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .sale-summary {
            background: rgba(106, 90, 205, 0.1);
            border: 2px solid rgba(106, 90, 205, 0.2);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 1.2rem;
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 1.4rem;
            border-top: 2px solid var(--primary);
            padding-top: 15px;
            margin-top: 20px;
        }
        .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        .category-item {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
        }
        body.dark-mode .category-item {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
        }
        .category-item:hover,
        .category-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .category-item .delete-category {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            display: none;
        }
        .category-item:hover .delete-category {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .expenses-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .summary-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .summary-card {
            background: var(--dark-card);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .summary-card.income {
            border-top-color: var(--income);
        }
        .summary-card.expenses {
            border-top-color: var(--expense);
        }
        .summary-card.net {
            border-top-color: var(--primary);
        }
        .summary-label {
            font-size: 1.1rem;
            color: var(--gray);
            margin-bottom: 10px;
        }
        body.dark-mode .summary-label {
            color: #a0a0a0;
        }
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        .income-value {
            color: var(--income);
        }
        .expenses-value {
            color: var(--expense);
        }
        .net-value {
            color: var(--primary);
        }
        .expenses-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease;
        }
        body.dark-mode .summary-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }
        .summary-card:hover {
            transform: translateY(-3px);
        }
        .summary-card.expense {
            border-left: 4px solid var(--expense);
        }
        .summary-card.income {
            border-left: 4px solid var(--income);
        }
        .summary-card.net-profit {
            border-left: 4px solid var(--primary);
        }
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        .summary-card.expense .card-icon {
            background: var(--expense);
        }
        .summary-card.income .card-icon {
            background: var(--income);
        }
        .summary-card.net-profit .card-icon {
            background: var(--primary);
        }
        .card-content h3 {
            margin: 0 0 10px;
            font-size: 1.1rem;
            color: var(--gray);
        }
        body.dark-mode .card-content h3 {
            color: var(--dark-text);
        }
        .card-content p {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
        }
        body.dark-mode .card-content p {
            color: var(--dark-text);
        }
        .reorder-alert {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--danger);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        .reorder-alert h4 {
            color: var(--danger);
            margin-bottom: 10px;
        }
        .reorder-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed var(--danger);
        }
        .reorder-item:last-child {
            border-bottom: none;
        }
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .confirmation-modal.show {
            opacity: 1;
            pointer-events: all;
        }
        .confirmation-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .confirmation-modal.show .confirmation-content {
            transform: translateY(0);
        }
        body.dark-mode .confirmation-content {
            background: var(--dark-card);
        }
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        .confirmation-buttons .btn {
            flex: 1;
        }
        .editable-amount {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .editable-amount:hover {
            background: rgba(106, 90, 205, 0.1);
            border-color: var(--primary);
        }
        .editable-status {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .editable-status:hover {
            transform: scale(1.05);
        }
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s ease;
            min-width: 350px;
            text-align: center;
            max-width: 90%;
            animation: notificationSlide 0.4s ease;
        }
        @keyframes notificationSlide {
            from { transform: translate(-50%, -70%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }
        .notification.show {
            opacity: 1;
        }
        .notification.success {
            background: var(--success);
        }
        .notification.error {
            background: var(--danger);
        }
        .notification.warning {
            background: var(--warning);
        }
        .notification-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .notification-content {
            font-size: 1.1rem;
            font-weight: 600;
        }
        #add-product-form {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(106, 90, 205, 0.1);
        }
        body.dark-mode #add-product-form {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }
        @media (max-width: 992px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            .tab {
                padding: 15px 10px;
                font-size: 1rem;
            }
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding-top: 60px;
            }
            .theme-toggle {
                top: 15px;
                left: 15px;
            }
            .lang-toggle {
                top: 15px;
                left: 65px;
            }
        }
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            .tab {
                flex: 1 0 45%;
                font-size: 0.95rem;
                padding: 12px;
            }
            .section-title {
                font-size: 1.5rem;
            }
            .form-control {
                padding: 12px;
                font-size: 1rem;
            }
            .action-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .expenses-summary {
                grid-template-columns: 1fr;
            }
        }

        /* Pop-up Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show {
            display: flex;
            opacity: 1;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            border: 1px solid rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .modal-content {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        body.dark-mode .modal-header {
            border-bottom: 2px solid var(--dark-border);
        }
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        body.dark-mode .modal-title {
            color: var(--primary-light);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close:hover {
            color: var(--danger);
        }
        .modal-form-group {
            margin-bottom: 20px;
        }
        .modal-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
        }
        body.dark-mode .modal-label {
            color: var(--dark-text);
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        body.dark-mode .modal-input {
            background: #2a2a2a;
            border: 2px solid var(--dark-border);
            color: var(--dark-text);
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2);
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .modal-btn-primary {
            background: var(--primary);
            color: white;
        }
        .modal-btn-primary:hover {
            background: #5949b8;
        }
        .modal-btn-secondary {
            background: var(--gray);
            color: white;
        }
        .modal-btn-secondary:hover {
            background: #6c7b7d;
        }
        @media (max-width: 480px) {
            .tab {
                flex: 1 0 100%;
            }
            .container {
                padding: 10px;
            }
            .tab-content {
                padding: 20px 15px;
            }
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            .confirmation-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="theme-toggle moon" id="theme-toggle">
            <i class="fas fa-moon"></i>
        </button>
        <button class="lang-toggle" id="lang-toggle">
            <i class="fas fa-language"></i> EN
        </button>
        <header>
            <div class="logo">
                <i class="fas fa-gift"></i>
                <div>
                    <h1 data-i18n="store-name">Enjoy The Gifts</h1>
                    <span data-i18n="store-subtitle">مبيعات - مخزون - مصروفات</span>
                </div>
            </div>
            <div class="date-display">
                <i class="fas fa-calendar-alt"></i>
                <div id="current-date">السبت، ٦ أغسطس ٢٠٢٥</div>
            </div>
        </header>
        <div class="nav-tabs">
            <div class="tab active" data-tab="dashboard"><i class="fas fa-home"></i> <span data-i18n="dashboard-tab">لوحة التحكم</span></div>
            <div class="tab" data-tab="sales"><i class="fas fa-shopping-cart"></i> <span data-i18n="sales-tab">إدارة المبيعات</span></div>
            <div class="tab" data-tab="inventory"><i class="fas fa-boxes"></i> <span data-i18n="inventory-tab">إدارة المخزون</span></div>
            <div class="tab" data-tab="expenses"><i class="fas fa-money-bill"></i> <span data-i18n="expenses-tab">إدارة المصروفات</span></div>
            <div class="tab" data-tab="reports"><i class="fas fa-chart-bar"></i> <span data-i18n="reports-tab">التقارير</span></div>
            <div class="tab" data-tab="admin"><i class="fas fa-user-shield"></i> <span data-i18n="admin-tab">سجل الإدارة</span></div>
        </div>



        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard-content">
            <div class="action-bar">
                <div>
                    <h2 class="section-title" data-i18n="today-sales">مبيعات اليوم</h2>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="add-sale-btn">
                        <i class="fas fa-plus"></i> <span data-i18n="add-new-sale">إضافة بيع جديد</span>
                    </button>
                </div>
            </div>
            <div class="filter-bar" style="margin-bottom: 20px;">
                <input type="text" class="form-control" id="dashboard-search" placeholder="بحث باسم العميل أو رقم الفاتورة أو رقم الهاتف..." style="width: 100%; padding: 12px 15px;">
            </div>
            <div id="sales-list">
                <div class="empty-state">
                    <i class="fas fa-file-invoice"></i>
                    <h3 data-i18n="no-sales">لا توجد مبيعات مسجلة</h3>
                    <p data-i18n="no-sales-desc">لم تقم بإضافة أي مبيعات بعد. يمكنك البدء بإضافة بيع جديد باستخدام الزر بالأعلى.</p>
                </div>
            </div>
            <div class="action-bar" style="margin-top: 40px;">
                <h2 class="section-title" data-i18n="previous-sales">المبيعات السابقة</h2>
                <div class="filter-bar">
                    <input type="date" class="form-control" id="filter-date" style="width: auto; padding: 10px 15px;">
                    <button class="btn btn-primary" id="filter-sales-btn">
                        <i class="fas fa-filter"></i> <span data-i18n="filter">تصفية</span>
                    </button>
                </div>
            </div>
            <div id="previous-sales-list">
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h3 data-i18n="no-previous-sales">لا توجد مبيعات سابقة</h3>
                    <p data-i18n="no-previous-sales-desc">لم يتم تسجيل أي مبيعات سابقة بعد.</p>
                </div>
            </div>
        </div>

        <!-- Sales Management Tab -->
        <div class="tab-content" id="sales-content">
            <h2 class="section-title" data-i18n="sales-management">إدارة المبيعات</h2>
            <div class="sale-steps">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <div class="step-label" data-i18n="select-customer">تحديد العميل</div>
                </div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <div class="step-label" data-i18n="add-products">إضافة المنتجات</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label" data-i18n="payment">الدفع والتسجيل</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" data-i18n="customer-name">اسم العميل</label>
                        <input type="text" class="form-control" placeholder="أدخل اسم العميل" id="customer-name">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" data-i18n="customer-phone">رقم الهاتف</label>
                        <input type="tel" class="form-control" placeholder="أدخل رقم الهاتف" id="customer-phone">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label" data-i18n="sale-date">تاريخ البيع</label>
                        <input type="date" class="form-control" id="sale-date">
                    </div>
                </div>
            </div>
            <h3 data-i18n="available-products">المنتجات المتاحة</h3>
            <div class="category-list" id="product-categories">
                <div class="category-item active" data-category="all" data-i18n="all-categories">جميع الفئات</div>
            </div>
            <div class="product-grid" id="products-grid">
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h3 data-i18n="no-products">لا توجد منتجات متاحة</h3>
                    <p data-i18n="no-products-desc">لم يتم إضافة أي منتجات بعد. يرجى إضافة منتجات من قسم إدارة المخزون أولاً.</p>
                </div>
            </div>
            <h3 data-i18n="selected-products">المنتجات المحددة</h3>
            <div id="selected-products">
                <div class="empty-state">
                    <i class="fas fa-shopping-basket"></i>
                    <h3 data-i18n="no-selected-products">لم يتم تحديد أي منتجات</h3>
                    <p data-i18n="no-selected-products-desc">اختر المنتجات من القائمة أعلاه لإضافتها إلى البيع.</p>
                </div>
            </div>
            <div class="sale-summary" id="sale-summary" style="display: none;">
                <h3 data-i18n="sale-summary">ملخص البيع</h3>
                <div class="summary-row">
                    <span data-i18n="subtotal">المجموع الفرعي:</span>
                    <span id="subtotal">0.00 جنيه</span>
                </div>
                <div class="summary-row">
                    <span data-i18n="paid-amount">المبلغ المدفوع:</span>
                    <input type="number" class="form-control" id="paid-amount" placeholder="0.00" style="width: 150px; display: inline-block;">
                </div>
                <div class="summary-row total">
                    <span data-i18n="remaining-amount">المبلغ المتبقي:</span>
                    <span id="remaining-amount">0.00 جنيه</span>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="order-status">حالة الطلب</label>
                    <select class="form-control" id="order-status">
                        <option value="pending" data-i18n="pending">معلق</option>
                        <option value="in-progress" data-i18n="in-progress">قيد التنفيذ</option>
                        <option value="completed" data-i18n="completed">مكتمل</option>
                        <option value="cancelled" data-i18n="cancelled">ملغي</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="additional-notes">ملاحظات إضافية</label>
                    <textarea class="form-control" id="sale-notes" placeholder="أي ملاحظات إضافية حول الطلب"></textarea>
                </div>
                <button class="btn btn-success btn-block" id="complete-sale-btn">
                    <i class="fas fa-check"></i> <span data-i18n="complete-sale">تسجيل البيع وطباعة الفاتورة</span>
                </button>
            </div>
        </div>

        <!-- Inventory Management Tab -->
        <div class="tab-content" id="inventory-content">
            <h2 class="section-title" data-i18n="inventory-management">إدارة المخزون</h2>
            <div class="action-bar">
                <div>
                    <button class="btn btn-primary" id="add-product-btn">
                        <i class="fas fa-plus"></i> <span data-i18n="add-new-product">إضافة منتج جديد</span>
                    </button>
                </div>
            </div>
            
            <!-- Reorder Alert -->
            <div id="reorder-alert" class="reorder-alert" style="display: none;">
                <h4><i class="fas fa-exclamation-triangle"></i> منتجات تحتاج إعادة طلب</h4>
                <div id="reorder-list"></div>
            </div>

            <div id="add-product-form" style="display: none;">
                <h3 data-i18n="add-category">إدارة الفئات</h3>
                <div class="form-group">
                    <label class="form-label" data-i18n="new-category-name">اسم الفئة الجديدة</label>
                    <input type="text" class="form-control" id="new-category-name" placeholder="أدخل اسم الفئة">
                </div>
                <button class="btn btn-primary" id="add-category-btn">
                    <i class="fas fa-plus"></i> <span data-i18n="add-category">إضافة فئة</span>
                </button>
                <div class="form-group">
                    <label class="form-label" data-i18n="available-categories">الفئات المتاحة</label>
                    <div id="available-categories">
                        <div class="empty-state">
                            <p data-i18n="no-categories">لا توجد فئات متاحة</p>
                        </div>
                    </div>
                </div>
                <h3 data-i18n="product-list">قائمة المنتجات</h3>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" data-i18n="product-name">اسم المنتج</label>
                            <input type="text" class="form-control" id="product-name" placeholder="أدخل اسم المنتج">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" data-i18n="product-category">الفئة</label>
                            <select class="form-control" id="product-category">
                                <option value="" data-i18n="select-category">اختر فئة</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" data-i18n="wholesale-price">سعر الجملة (جنيه)</label>
                            <input type="number" class="form-control" id="wholesale-price" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" data-i18n="product-price">سعر البيع (جنيه)</label>
                            <input type="number" class="form-control" id="product-price" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" data-i18n="product-quantity">الكمية</label>
                            <input type="number" class="form-control" id="product-quantity" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" data-i18n="min-stock">الحد الأدنى للمخزون</label>
                            <input type="number" class="form-control" id="min-stock" placeholder="5" min="0">
                        </div>
                    </div>
                </div>
                <button class="btn btn-success btn-block" id="save-product-btn">
                    <i class="fas fa-save"></i> <span data-i18n="save-product">حفظ المنتج</span>
                </button>
            </div>
            <div class="product-grid" id="inventory-grid">
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h3 data-i18n="no-products-inventory">لا توجد منتجات في المخزون</h3>
                    <p data-i18n="no-products-inventory-desc">لم يتم إضافة أي منتجات بعد. يمكنك البدء بإضافة منتج جديد باستخدام الزر بالأعلى.</p>
                </div>
            </div>
        </div>

        <!-- Expenses Management Tab -->
        <div class="tab-content" id="expenses-content">
            <h2 class="section-title" data-i18n="expenses-management">إدارة المصروفات والإيرادات</h2>
            <div class="expenses-summary">
                <div class="summary-card expense">
                    <div class="card-icon"><i class="fas fa-arrow-down"></i></div>
                    <div class="card-content">
                        <h3 data-i18n="today-expenses">مصروفات اليوم</h3>
                        <p id="today-expenses-total">0.00 جنيه</p>
                    </div>
                </div>
                <div class="summary-card income">
                    <div class="card-icon"><i class="fas fa-arrow-up"></i></div>
                    <div class="card-content">
                        <h3 data-i18n="today-income">إيرادات اليوم</h3>
                        <p id="today-income-total">0.00 جنيه</p>
                    </div>
                </div>
                <div class="summary-card net-profit">
                    <div class="card-icon"><i class="fas fa-balance-scale"></i></div>
                    <div class="card-content">
                        <h3 data-i18n="net-profit">صافي الربح اليومي</h3>
                        <p id="today-net-profit">0.00 جنيه</p>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-col">
                    <h3 data-i18n="add-expense">إضافة مصروف</h3>
                    <div class="form-group">
                        <label class="form-label" data-i18n="expense-description">وصف المصروف</label>
                        <input type="text" class="form-control" id="expense-description" placeholder="مثال: إيجار، كهرباء، مواد خام">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="expense-amount">المبلغ (جنيه)</label>
                        <input type="number" class="form-control" id="expense-amount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="expense-date">التاريخ</label>
                        <input type="date" class="form-control" id="expense-date">
                    </div>
                    <button class="btn btn-danger btn-block" id="add-expense-btn">
                        <i class="fas fa-plus"></i> <span data-i18n="add-expense">إضافة مصروف</span>
                    </button>
                </div>
                <div class="form-col">
                    <h3 data-i18n="add-income">إضافة إيراد</h3>
                    <div class="form-group">
                        <label class="form-label" data-i18n="income-description">وصف الإيراد</label>
                        <input type="text" class="form-control" id="revenue-description" placeholder="مثال: مبيعات المحل، أوردرات">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="income-amount">المبلغ (جنيه)</label>
                        <input type="number" class="form-control" id="revenue-amount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="income-date">التاريخ</label>
                        <input type="date" class="form-control" id="revenue-date">
                    </div>
                    <button class="btn btn-success btn-block" id="add-revenue-btn">
                        <i class="fas fa-plus"></i> <span data-i18n="add-income">إضافة إيراد</span>
                    </button>
                </div>
            </div>

            <div class="action-bar" style="margin-top: 40px;">
                <h2 class="section-title" data-i18n="expenses-revenues-filter">فلترة المصروفات والإيرادات</h2>
                <div class="filter-bar">
                    <input type="date" class="form-control" id="filter-expense-date" style="width: auto; padding: 10px 15px;">
                    <button class="btn btn-primary" id="filter-expenses-btn">
                        <i class="fas fa-filter"></i> <span data-i18n="filter">تصفية</span>
                    </button>
                    <button class="btn btn-info" id="clear-expense-filter-btn">
                        <i class="fas fa-times"></i> <span data-i18n="clear-filter">إزالة التصفية</span>
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-col">
                    <h3 data-i18n="revenues-list">قائمة الإيرادات</h3>
                    <div id="revenue-list">
                        <div class="empty-state">
                            <i class="fas fa-coins"></i>
                            <h3 data-i18n="no-revenues">لا توجد إيرادات مسجلة</h3>
                        </div>
                    </div>
                </div>
                <div class="form-col">
                    <h3 data-i18n="expenses-list">قائمة المصروفات</h3>
                    <div id="expenses-list">
                        <div class="empty-state">
                            <i class="fas fa-receipt"></i>
                            <h3 data-i18n="no-expenses">لا توجد مصروفات مسجلة</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reports-content">
            <h2 class="section-title" data-i18n="financial-reports">التقارير المالية</h2>
            
            <!-- Saved Invoices Section -->
            <div class="action-bar">
                <h3>إدارة الفواتير المحفوظة</h3>
                <div class="filter-bar">
                    <input type="text" class="form-control" id="invoice-search" placeholder="بحث في الفواتير..." style="width: 300px;">
                    <button class="btn btn-primary" id="search-invoices-btn">
                        <i class="fas fa-search"></i> بحث
                    </button>
                    <button class="btn btn-success" id="export-data-btn">
                        <i class="fas fa-download"></i> تصدير البيانات
                    </button>
                    <input type="file" id="import-file" accept=".json" style="display: none;">
                    <button class="btn btn-info" id="import-data-btn">
                        <i class="fas fa-upload"></i> استيراد البيانات
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th>
                            <th>التاريخ</th>
                            <th>العميل</th>
                            <th>رقم الهاتف</th>
                            <th>إجمالي المبلغ</th>
                            <th>المدفوع</th>
                            <th>المتبقي</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="saved-invoices-table">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice"></i>
                                    <h3>لا توجد فواتير محفوظة</h3>
                                    <p>لم يتم حفظ أي فواتير بعد.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="expenses-summary">
                <div class="summary-card expenses">
                    <div class="summary-label" data-i18n="total-expenses">إجمالي المصروفات</div>
                    <div class="summary-value expenses-value" id="total-expenses">0.00 جنيه</div>
                </div>
                <div class="summary-card income">
                    <div class="summary-label" data-i18n="total-revenue">إجمالي الإيرادات</div>
                    <div class="summary-value income-value" id="total-revenue">0.00 جنيه</div>
                </div>
                <div class="summary-card net">
                    <div class="summary-label" data-i18n="total-net-profit">إجمالي صافي الربح</div>
                    <div class="summary-value net-value" id="total-net-profit">0.00 جنيه</div>
                </div>
            </div>
            
            <div class="action-bar">
                <h3>فلتر التقارير المالية</h3>
                <div class="filter-bar">
                    <input type="date" class="form-control" id="financial-from-date" style="width: auto;">
                    <span data-i18n="to">إلى</span>
                    <input type="date" class="form-control" id="financial-to-date" style="width: auto;">
                    <button class="btn btn-success" id="filter-financial-btn">
                        <i class="fas fa-filter"></i> فلترة التقارير المالية
                    </button>
                    <button class="btn btn-secondary" id="clear-financial-filter-btn">
                        <i class="fas fa-times"></i> إزالة الفلتر
                    </button>
                </div>
            </div>
            
            <div class="action-bar">
                <h3 data-i18n="sales-reports">تقارير المبيعات</h3>
                <div class="filter-bar">
                    <input type="date" class="form-control" id="report-from-date" style="width: auto;">
                    <span data-i18n="to">إلى</span>
                    <input type="date" class="form-control" id="report-to-date" style="width: auto;">
                    <button class="btn btn-info" id="generate-report-btn">
                        <i class="fas fa-chart-line"></i> <span data-i18n="generate-report">إنشاء تقرير</span>
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th data-i18n="invoice-number">رقم الفاتورة</th>
                            <th data-i18n="date">التاريخ</th>
                            <th data-i18n="customer">العميل</th>
                            <th data-i18n="total-amount">إجمالي المبلغ</th>
                            <th data-i18n="paid-amount">المدفوع</th>
                            <th data-i18n="remaining-amount">المتبقي</th>
                            <th data-i18n="status">الحالة</th>
                            <th data-i18n="actions">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="sales-report-table">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-chart-bar"></i>
                                    <h3 data-i18n="no-sales-data">لا توجد بيانات مبيعات</h3>
                                    <p data-i18n="no-sales-data-desc">لم يتم تسجيل أي مبيعات في الفترة المحددة.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Tab -->
        <div class="tab-content" id="admin-content">
            <div id="admin-login-section">
                <h2 class="section-title">تسجيل الدخول للوحة الإدارة</h2>
                <div style="max-width: 400px; margin: 50px auto; text-align: center;">
                    <div class="form-group">
                        <label class="form-label">كلمة المرور</label>
                        <input type="password" class="form-control" id="admin-password" placeholder="أدخل كلمة المرور">
                    </div>
                    <button class="btn btn-primary btn-block" id="admin-login-btn">
                        <i class="fas fa-sign-in-alt"></i> دخول
                    </button>
                    <div id="admin-error-message" style="color: var(--danger); margin-top: 10px; display: none;">
                        كلمة المرور غير صحيحة
                    </div>
                </div>
            </div>

            <div id="admin-panel-section" style="display: none;">
                <h2 class="section-title">لوحة الإدارة - الفواتير المحذوفة</h2>
                
                <div class="action-bar">
                    <div class="filter-bar">
                        <input type="text" class="form-control" id="deleted-search" placeholder="بحث في الفواتير المحذوفة..." style="width: 300px;">
                        <button class="btn btn-info" id="search-deleted-btn">
                            <i class="fas fa-search"></i> بحث
                        </button>
                        <button class="btn btn-secondary" id="admin-logout-btn">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>رقم الهاتف</th>
                                <th>إجمالي المبلغ</th>
                                <th>المدفوع</th>
                                <th>تاريخ الحذف</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="deleted-invoices-table">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <i class="fas fa-trash-alt"></i>
                                        <h3>لا توجد فواتير محذوفة</h3>
                                        <p>لم يتم حذف أي فواتير بعد.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="confirmation-content">
            <h3 id="confirmation-title">تأكيد الحذف</h3>
            <p id="confirmation-message">هل أنت متأكد من أنك تريد حذف هذا العنصر؟</p>
            <div class="confirmation-buttons">
                <button class="btn btn-danger" id="confirm-delete">نعم، احذف</button>
                <button class="btn btn-secondary" id="cancel-delete">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let revenues = JSON.parse(localStorage.getItem('revenues')) || [];
        let deletedInvoices = JSON.parse(localStorage.getItem('deletedInvoices')) || [];
        let selectedProducts = [];
        let currentTab = 'dashboard';
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let currentLang = localStorage.getItem('language') || 'ar';
        let confirmationCallback = null;
        let isAdminLoggedIn = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeDatabase();
            await registerServiceWorker();
            initializeApp();
            setupEventListeners();
            updateCurrentDate();
            loadData();
        });

        // Register Service Worker for PWA functionality
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('Service Worker registered successfully:', registration);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showNotification('تحديث جديد متاح! سيتم تطبيقه عند إعادة تحميل الصفحة.', 'info');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }

        // Check if app can be installed
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        // Show install button
        function showInstallButton() {
            const installButton = document.createElement('button');
            installButton.className = 'btn btn-success';
            installButton.innerHTML = '<i class="fas fa-download"></i> تثبيت التطبيق';
            installButton.style.position = 'fixed';
            installButton.style.bottom = '20px';
            installButton.style.right = '20px';
            installButton.style.zIndex = '1000';
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        showNotification('تم تثبيت التطبيق بنجاح!', 'success');
                    }
                    deferredPrompt = null;
                    installButton.remove();
                }
            });
            
            document.body.appendChild(installButton);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (installButton.parentNode) {
                    installButton.remove();
                }
            }, 10000);
        }

        // Handle app installation
        window.addEventListener('appinstalled', () => {
            showNotification('تم تثبيت التطبيق بنجاح! يمكنك الآن الوصول إليه من الشاشة الرئيسية.', 'success');
        });

        // Check online/offline status
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('online-status') || createStatusIndicator();
            
            if (navigator.onLine) {
                statusIndicator.innerHTML = '<i class="fas fa-wifi"></i> متصل';
                statusIndicator.className = 'online-status online';
            } else {
                statusIndicator.innerHTML = '<i class="fas fa-wifi-slash"></i> غير متصل';
                statusIndicator.className = 'online-status offline';
            }
        }

        function createStatusIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'online-status';
            indicator.style.cssText = `
                position: fixed;
                top: 80px;
                left: 20px;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 600;
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(indicator);
            return indicator;
        }

        // Listen for online/offline events
        window.addEventListener('online', () => {
            updateOnlineStatus();
            showNotification('تم استعادة الاتصال بالإنترنت', 'success');
        });

        window.addEventListener('offline', () => {
            updateOnlineStatus();
            showNotification('تم فقدان الاتصال بالإنترنت - التطبيق يعمل في الوضع غير المتصل', 'warning');
        });

        // Initialize online status
        document.addEventListener('DOMContentLoaded', () => {
            updateOnlineStatus();
            initializeTouchSupport();
        });

        // Initialize touch support for mobile devices
        function initializeTouchSupport() {
            // Add touch event listeners for better mobile experience
            document.addEventListener('touchstart', function() {}, { passive: true });
            
            // Prevent double-tap zoom on buttons
            document.querySelectorAll('.btn, .tab').forEach(element => {
                element.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                }, { passive: false });
            });
            
            // Add swipe support for tabs
            let startX = 0;
            let startY = 0;
            
            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                if (!startX || !startY) return;
                
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                
                const diffX = startX - endX;
                const diffY = startY - endY;
                
                // Only process horizontal swipes
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    const tabs = ['dashboard', 'sales', 'inventory', 'expenses', 'reports', 'admin'];
                    const currentIndex = tabs.indexOf(currentTab);
                    
                    if (diffX > 0 && currentIndex < tabs.length - 1) {
                        // Swipe left - next tab
                        switchTab(tabs[currentIndex + 1]);
                    } else if (diffX < 0 && currentIndex > 0) {
                        // Swipe right - previous tab
                        switchTab(tabs[currentIndex - 1]);
                    }
                }
                
                startX = 0;
                startY = 0;
            }, { passive: true });
        }

        // Optimize for mobile viewport
        function optimizeForMobile() {
            // Adjust viewport height for mobile browsers
            const setVH = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            
            setVH();
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', setVH);
        }

        // Call mobile optimization on load
        document.addEventListener('DOMContentLoaded', optimizeForMobile);

        // Initialize database
        async function initializeDatabase() {
            try {
                await invoiceDB.init();
                console.log('تم تهيئة قاعدة البيانات بنجاح');
                
                // Migrate existing data from localStorage to IndexedDB
                await migrateExistingData();
            } catch (error) {
                console.error('خطأ في تهيئة قاعدة البيانات:', error);
                showNotification('خطأ في تهيئة قاعدة البيانات', 'error');
            }
        }

        // Migrate existing data from localStorage to IndexedDB
        async function migrateExistingData() {
            try {
                // Check if migration has already been done
                const migrationFlag = localStorage.getItem('dataMigrated');
                if (migrationFlag === 'true') {
                    return;
                }

                // Migrate products
                const existingProducts = JSON.parse(localStorage.getItem('products')) || [];
                for (const product of existingProducts) {
                    try {
                        await invoiceDB.saveProduct(product);
                    } catch (error) {
                        console.warn('تم تخطي منتج موجود:', product.name);
                    }
                }

                // Migrate sales (invoices)
                const existingSales = JSON.parse(localStorage.getItem('sales')) || [];
                for (const sale of existingSales) {
                    try {
                        await invoiceDB.saveInvoice(sale);
                    } catch (error) {
                        console.warn('تم تخطي فاتورة موجودة:', sale.invoiceNumber);
                    }
                }

                // Set migration flag
                localStorage.setItem('dataMigrated', 'true');
                console.log('تم ترحيل البيانات الموجودة بنجاح');
            } catch (error) {
                console.error('خطأ في ترحيل البيانات:', error);
            }
        }

        function initializeApp() {
            // Apply saved theme
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
                document.getElementById('theme-toggle').classList.remove('moon');
                document.getElementById('theme-toggle').classList.add('sun');
            }

            // Apply saved language
            if (currentLang === 'en') {
                document.body.setAttribute('dir', 'ltr');
                document.body.setAttribute('lang', 'en');
                document.getElementById('lang-toggle').innerHTML = '<i class="fas fa-language"></i> AR';
            }

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sale-date').value = today;
            document.getElementById('expense-date').value = today;
            document.getElementById('revenue-date').value = today;
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // Language toggle
            document.getElementById('lang-toggle').addEventListener('click', toggleLanguage);

            // Product management
            document.getElementById('add-product-btn').addEventListener('click', toggleProductForm);
            document.getElementById('add-category-btn').addEventListener('click', addCategory);
            document.getElementById('save-product-btn').addEventListener('click', saveProduct);

            // Sales management
            document.getElementById('add-sale-btn').addEventListener('click', () => switchTab('sales'));
            document.getElementById('complete-sale-btn').addEventListener('click', completeSale);
            document.getElementById('paid-amount').addEventListener('input', calculateRemainingAmount);

            // Expense management
            document.getElementById('add-expense-btn').addEventListener('click', addExpense);
            document.getElementById('add-revenue-btn').addEventListener('click', addRevenue);
            document.getElementById('filter-expenses-btn').addEventListener('click', filterExpenses);
            document.getElementById('clear-expense-filter-btn').addEventListener('click', clearExpenseFilter);

            // Reports
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('filter-sales-btn').addEventListener('click', filterSales);
            document.getElementById('filter-financial-btn').addEventListener('click', filterFinancialReports);
            document.getElementById('clear-financial-filter-btn').addEventListener('click', clearFinancialFilter);

            // Invoice management
            document.getElementById('search-invoices-btn').addEventListener('click', searchInvoices);
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file').click());
            document.getElementById('import-file').addEventListener('change', importData);

            // Search
            document.getElementById('dashboard-search').addEventListener('input', searchSales);

            // Confirmation modal
            document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
            document.getElementById('cancel-delete').addEventListener('click', cancelDelete);

            // Admin panel
            document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', adminLogout);
            document.getElementById('search-deleted-btn').addEventListener('click', searchDeletedInvoices);
            document.getElementById('deleted-search').addEventListener('input', searchDeletedInvoices);

            // Close modal on outside click
            document.getElementById('confirmation-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelDelete();
                }
            });
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-content`).classList.add('active');

            currentTab = tabName;

            // Load data for the current tab
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'sales':
                    loadSalesTab();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'expenses':
                    loadExpenses();
                    break;
                case 'reports':
                    await loadReports();
                    break;
                case 'admin':
                    loadAdminPanel();
                    break;
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            
            const themeToggle = document.getElementById('theme-toggle');
            if (isDarkMode) {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggle.classList.remove('moon');
                themeToggle.classList.add('sun');
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggle.classList.remove('sun');
                themeToggle.classList.add('moon');
            }
            
            localStorage.setItem('darkMode', isDarkMode);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            
            if (currentLang === 'en') {
                document.body.setAttribute('dir', 'ltr');
                document.body.setAttribute('lang', 'en');
                document.getElementById('lang-toggle').innerHTML = '<i class="fas fa-language"></i> AR';
                translateToEnglish();
            } else {
                document.body.setAttribute('dir', 'rtl');
                document.body.setAttribute('lang', 'ar');
                document.getElementById('lang-toggle').innerHTML = '<i class="fas fa-language"></i> EN';
                translateToArabic();
            }
            
            localStorage.setItem('language', currentLang);
            updateCurrentDate();
            
            // Reload current tab to apply translations
            switch(currentTab) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'sales':
                    loadSalesTab();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'expenses':
                    loadExpenses();
                    break;
                case 'reports':
                    await loadReports();
                    break;
            }
        }

        function translateToEnglish() {
            const translations = {
                'store-name': 'Enjoy The Gifts',
                'store-subtitle': 'Sales - Inventory - Expenses',
                'dashboard-tab': 'Dashboard',
                'sales-tab': 'Sales Management',
                'inventory-tab': 'Inventory Management',
                'expenses-tab': 'Expenses Management',
                'reports-tab': 'Reports',
                'today-sales': 'Today\'s Sales',
                'add-new-sale': 'Add New Sale',
                'no-sales': 'No Sales Recorded',
                'no-sales-desc': 'You haven\'t added any sales yet. You can start by adding a new sale using the button above.',
                'previous-sales': 'Previous Sales',
                'filter': 'Filter',
                'no-previous-sales': 'No Previous Sales',
                'no-previous-sales-desc': 'No previous sales have been recorded yet.',
                'sales-management': 'Sales Management',
                'select-customer': 'Select Customer',
                'add-products': 'Add Products',
                'payment': 'Payment & Registration',
                'customer-name': 'Customer Name',
                'customer-phone': 'Phone Number',
                'sale-date': 'Sale Date',
                'available-products': 'Available Products',
                'all-categories': 'All Categories',
                'no-products': 'No Products Available',
                'no-products-desc': 'No products have been added yet. Please add products from the inventory management section first.',
                'selected-products': 'Selected Products',
                'no-selected-products': 'No Products Selected',
                'no-selected-products-desc': 'Select products from the list above to add them to the sale.',
                'sale-summary': 'Sale Summary',
                'subtotal': 'Subtotal:',
                'paid-amount': 'Paid Amount:',
                'remaining-amount': 'Remaining Amount:',
                'order-status': 'Order Status',
                'pending': 'Pending',
                'in-progress': 'In Progress',
                'completed': 'Completed',
                'cancelled': 'Cancelled',
                'additional-notes': 'Additional Notes',
                'complete-sale': 'Complete Sale & Print Invoice',
                'inventory-management': 'Inventory Management',
                'add-new-product': 'Add New Product',
                'add-category': 'Add Category',
                'new-category-name': 'New Category Name',
                'available-categories': 'Available Categories',
                'no-categories': 'No Categories Available',
                'product-list': 'Product List',
                'product-name': 'Product Name',
                'product-category': 'Category',
                'select-category': 'Select Category',
                'wholesale-price': 'Wholesale Price (EGP)',
                'product-price': 'Sale Price (EGP)',
                'product-quantity': 'Quantity',
                'min-stock': 'Minimum Stock',
                'save-product': 'Save Product',
                'no-products-inventory': 'No Products in Inventory',
                'no-products-inventory-desc': 'No products have been added yet. You can start by adding a new product using the button above.',
                'expenses-management': 'Expenses & Revenue Management',
                'today-expenses': 'Today\'s Expenses',
                'today-income': 'Today\'s Income',
                'net-profit': 'Daily Net Profit',
                'add-expense': 'Add Expense',
                'expense-description': 'Expense Description',
                'expense-amount': 'Amount (EGP)',
                'expense-date': 'Date',
                'add-income': 'Add Income',
                'income-description': 'Income Description',
                'income-amount': 'Amount (EGP)',
                'income-date': 'Date',
                'expenses-revenues-filter': 'Filter Expenses & Revenues',
                'clear-filter': 'Clear Filter',
                'revenues-list': 'Revenue List',
                'expenses-list': 'Expenses List',
                'no-revenues': 'No Revenues Recorded',
                'no-expenses': 'No Expenses Recorded'
            };

            Object.keys(translations).forEach(key => {
                const element = document.querySelector(`[data-i18n="${key}"]`);
                if (element) {
                    element.textContent = translations[key];
                }
            });

            // Update placeholders
            const placeholders = {
                'customer-name': 'Enter customer name',
                'customer-phone': 'Enter phone number',
                'expense-description': 'e.g: Rent, electricity, raw materials',
                'revenue-description': 'e.g: Store sales, orders',
                'new-category-name': 'Enter category name',
                'product-name': 'Enter product name'
            };

            Object.keys(placeholders).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.placeholder = placeholders[id];
                }
            });
        }

        function translateToArabic() {
            const translations = {
                'store-name': 'Enjoy The Gifts',
                'store-subtitle': 'مبيعات - مخزون - مصروفات',
                'dashboard-tab': 'لوحة التحكم',
                'sales-tab': 'إدارة المبيعات',
                'inventory-tab': 'إدارة المخزون',
                'expenses-tab': 'إدارة المصروفات',
                'reports-tab': 'التقارير',
                'today-sales': 'مبيعات اليوم',
                'add-new-sale': 'إضافة بيع جديد',
                'no-sales': 'لا توجد مبيعات مسجلة',
                'no-sales-desc': 'لم تقم بإضافة أي مبيعات بعد. يمكنك البدء بإضافة بيع جديد باستخدام الزر بالأعلى.',
                'previous-sales': 'المبيعات السابقة',
                'filter': 'تصفية',
                'no-previous-sales': 'لا توجد مبيعات سابقة',
                'no-previous-sales-desc': 'لم يتم تسجيل أي مبيعات سابقة بعد.',
                'sales-management': 'إدارة المبيعات',
                'select-customer': 'تحديد العميل',
                'add-products': 'إضافة المنتجات',
                'payment': 'الدفع والتسجيل',
                'customer-name': 'اسم العميل',
                'customer-phone': 'رقم الهاتف',
                'sale-date': 'تاريخ البيع',
                'available-products': 'المنتجات المتاحة',
                'all-categories': 'جميع الفئات',
                'no-products': 'لا توجد منتجات متاحة',
                'no-products-desc': 'لم يتم إضافة أي منتجات بعد. يرجى إضافة منتجات من قسم إدارة المخزون أولاً.',
                'selected-products': 'المنتجات المحددة',
                'no-selected-products': 'لم يتم تحديد أي منتجات',
                'no-selected-products-desc': 'اختر المنتجات من القائمة أعلاه لإضافتها إلى البيع.',
                'sale-summary': 'ملخص البيع',
                'subtotal': 'المجموع الفرعي:',
                'paid-amount': 'المبلغ المدفوع:',
                'remaining-amount': 'المبلغ المتبقي:',
                'order-status': 'حالة الطلب',
                'pending': 'معلق',
                'in-progress': 'قيد التنفيذ',
                'completed': 'مكتمل',
                'cancelled': 'ملغي',
                'additional-notes': 'ملاحظات إضافية',
                'complete-sale': 'تسجيل البيع وطباعة الفاتورة',
                'inventory-management': 'إدارة المخزون',
                'add-new-product': 'إضافة منتج جديد',
                'add-category': 'إضافة فئة',
                'new-category-name': 'اسم الفئة الجديدة',
                'available-categories': 'الفئات المتاحة',
                'no-categories': 'لا توجد فئات متاحة',
                'product-list': 'قائمة المنتجات',
                'product-name': 'اسم المنتج',
                'product-category': 'الفئة',
                'select-category': 'اختر فئة',
                'wholesale-price': 'سعر الجملة (جنيه)',
                'product-price': 'سعر البيع (جنيه)',
                'product-quantity': 'الكمية',
                'min-stock': 'الحد الأدنى للمخزون',
                'save-product': 'حفظ المنتج',
                'no-products-inventory': 'لا توجد منتجات في المخزون',
                'no-products-inventory-desc': 'لم يتم إضافة أي منتجات بعد. يمكنك البدء بإضافة منتج جديد باستخدام الزر بالأعلى.',
                'expenses-management': 'إدارة المصروفات والإيرادات',
                'today-expenses': 'مصروفات اليوم',
                'today-income': 'إيرادات اليوم',
                'net-profit': 'صافي الربح اليومي',
                'add-expense': 'إضافة مصروف',
                'expense-description': 'وصف المصروف',
                'expense-amount': 'المبلغ (جنيه)',
                'expense-date': 'التاريخ',
                'add-income': 'إضافة إيراد',
                'income-description': 'وصف الإيراد',
                'income-amount': 'المبلغ (جنيه)',
                'income-date': 'التاريخ',
                'expenses-revenues-filter': 'فلترة المصروفات والإيرادات',
                'clear-filter': 'إزالة التصفية',
                'revenues-list': 'قائمة الإيرادات',
                'expenses-list': 'قائمة المصروفات',
                'no-revenues': 'لا توجد إيرادات مسجلة',
                'no-expenses': 'لا توجد مصروفات مسجلة'
            };

            Object.keys(translations).forEach(key => {
                const element = document.querySelector(`[data-i18n="${key}"]`);
                if (element) {
                    element.textContent = translations[key];
                }
            });

            // Update placeholders
            const placeholders = {
                'customer-name': 'أدخل اسم العميل',
                'customer-phone': 'أدخل رقم الهاتف',
                'expense-description': 'مثال: إيجار، كهرباء، مواد خام',
                'revenue-description': 'مثال: مبيعات المحل، أوردرات',
                'new-category-name': 'أدخل اسم الفئة',
                'product-name': 'أدخل اسم المنتج'
            };

            Object.keys(placeholders).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.placeholder = placeholders[id];
                }
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            let dateString;
            if (currentLang === 'ar') {
                dateString = now.toLocaleDateString('ar-EG', options);
            } else {
                dateString = now.toLocaleDateString('en-US', options);
            }
            
            document.getElementById('current-date').textContent = dateString;
        }

        async function loadData() {
            await loadDashboard();
            await loadInventory();
            loadExpenses();
            loadReports();
        }

        async function loadDashboard() {
            try {
                const allInvoices = await invoiceDB.getAllInvoices();
                sales = allInvoices; // Update global variable for compatibility
                
                const today = new Date().toISOString().split('T')[0];
                const todaySales = allInvoices.filter(sale => sale.date === today);
                
                displaySales(todaySales, 'sales-list');
                displaySales(allInvoices.filter(sale => sale.date !== today), 'previous-sales-list');
            } catch (error) {
                console.error('خطأ في تحميل لوحة التحكم:', error);
                showNotification('خطأ في تحميل البيانات', 'error');
            }
        }

        function loadSalesTab() {
            loadProductsForSale();
            loadCategories();
        }

        async function loadProductsForSale() {
            try {
                const allProducts = await invoiceDB.getAllProducts();
                products = allProducts; // Update global variable for compatibility
                
                const grid = document.getElementById('products-grid');
                
                if (products.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>لا توجد منتجات متاحة</h3>
                            <p>لم يتم إضافة أي منتجات بعد. يرجى إضافة منتجات من قسم إدارة المخزون أولاً.</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = products.map(product => `
                    <div class="product-card" onclick="addToSale(${product.id})">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price.toFixed(2)} جنيه</div>
                        <div class="product-stock">المتوفر: ${product.quantity}</div>
                        <div class="status ${getStockStatus(product.quantity, product.minStock || 5)}">${getStockStatusText(product.quantity, product.minStock || 5)}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                showNotification('خطأ في تحميل المنتجات', 'error');
            }
        }

        function loadCategories() {
            const categoriesContainer = document.getElementById('product-categories');
            const categorySelect = document.getElementById('product-category');
            const availableCategories = document.getElementById('available-categories');
            
            // Load categories for filtering
            categoriesContainer.innerHTML = `
                <div class="category-item active" data-category="all">جميع الفئات</div>
                ${categories.map(category => `
                    <div class="category-item" data-category="${category.id}">
                        ${category.name}
                    </div>
                `).join('')}
            `;

            // Load categories for product form
            categorySelect.innerHTML = `
                <option value="">اختر فئة</option>
                ${categories.map(category => `
                    <option value="${category.id}">${category.name}</option>
                `).join('')}
            `;

            // Load available categories with delete option
            if (categories.length === 0) {
                availableCategories.innerHTML = `
                    <div class="empty-state">
                        <p>لا توجد فئات متاحة</p>
                    </div>
                `;
            } else {
                availableCategories.innerHTML = categories.map(category => `
                    <div class="category-item">
                        ${category.name}
                        <button class="delete-category" onclick="deleteCategory(${category.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }

            // Add event listeners for category filtering
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.category-item').forEach(cat => cat.classList.remove('active'));
                    this.classList.add('active');
                    filterProductsByCategory(this.dataset.category);
                });
            });
        }

        function checkNegativeStock() {
            const negativeProducts = products.filter(p => p.quantity < 0);
            const reorderAlert = document.getElementById('reorder-alert');
            const reorderList = document.getElementById('reorder-list');
            
            if (negativeProducts.length > 0) {
                reorderAlert.style.display = 'block';
                reorderList.innerHTML = negativeProducts.map(product => `
                    <div class="reorder-item">
                        <span>${product.name}</span>
                        <span style="color: var(--danger); font-weight: bold;">الكمية: ${product.quantity}</span>
                    </div>
                `).join('');
            } else {
                reorderAlert.style.display = 'none';
            }
        }

        function loadInventory() {
            const grid = document.getElementById('inventory-grid');
            const reorderAlert = document.getElementById('reorder-alert');
            const reorderList = document.getElementById('reorder-list');
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>لا توجد منتجات في المخزون</h3>
                        <p>لم يتم إضافة أي منتجات بعد. يمكنك البدء بإضافة منتج جديد باستخدام الزر بالأعلى.</p>
                    </div>
                `;
                reorderAlert.style.display = 'none';
                return;
            }

            // Check for products that need reordering (including negative quantities)
            const reorderProducts = products.filter(product => product.quantity <= (product.minStock || 5));
            
            if (reorderProducts.length > 0) {
                reorderAlert.style.display = 'block';
                reorderList.innerHTML = reorderProducts.map(product => `
                    <div class="reorder-item">
                        <span>${product.name}</span>
                        <span style="color: ${product.quantity < 0 ? 'var(--danger)' : 'inherit'}">الكمية: ${product.quantity} (الحد الأدنى: ${product.minStock || 5})</span>
                    </div>
                `).join('');
            } else {
                reorderAlert.style.display = 'none';
            }

            grid.innerHTML = products.map(product => {
                const profit = (product.price || 0) - (product.wholesalePrice || 0);
                return `
                    <div class="product-card">
                        <div class="product-name">${product.name}</div>
                        <div class="product-wholesale-price">سعر الجملة: ${(product.wholesalePrice || 0).toFixed(2)} جنيه</div>
                        <div class="product-price">سعر البيع: ${(product.price || 0).toFixed(2)} جنيه</div>
                        <div class="product-profit">الربح: ${profit.toFixed(2)} جنيه</div>
                        <div class="product-stock" onclick="editQuantity(${product.id})" style="color: ${product.quantity < 0 ? 'var(--danger)' : 'inherit'}">الكمية: ${product.quantity}</div>
                        <div class="status ${getStockStatus(product.quantity, product.minStock || 5)}">${getStockStatusText(product.quantity, product.minStock || 5)}</div>
                        <div class="product-actions">
                            <button class="btn btn-sm btn-info" onclick="openProductModal(${product.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="showDeleteConfirmation('product', ${product.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            checkNegativeStock();
        }

        function loadExpenses() {
            const today = new Date().toISOString().split('T')[0];
            const todayExpenses = expenses.filter(expense => expense.date === today);
            const todayRevenues = revenues.filter(revenue => revenue.date === today);
            
            const todayExpensesTotal = todayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const todayRevenuesTotal = todayRevenues.reduce((sum, revenue) => sum + revenue.amount, 0);
            const netProfit = todayRevenuesTotal - todayExpensesTotal;

            // Update the summary cards with correct IDs
            document.getElementById('today-expenses-total').textContent = `${todayExpensesTotal.toFixed(2)} جنيه`;
            document.getElementById('today-income-total').textContent = `${todayRevenuesTotal.toFixed(2)} جنيه`;
            document.getElementById('today-net-profit').textContent = `${netProfit.toFixed(2)} جنيه`;
            
            // Set today's date as default for new entries
            document.getElementById('expense-date').value = today;
            document.getElementById('revenue-date').value = today;

            displayExpenses(expenses, 'expenses-list');
            displayRevenues(revenues, 'revenue-list');
        }

        async function loadReports() {
            try {
                // Load saved invoices
                await loadSavedInvoices();
                
                const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
                const totalRevenues = revenues.reduce((sum, revenue) => sum + revenue.amount, 0);
                const totalNetProfit = totalRevenues - totalExpenses;

                document.getElementById('total-expenses').textContent = `${totalExpenses.toFixed(2)} جنيه`;
                document.getElementById('total-revenue').textContent = `${totalRevenues.toFixed(2)} جنيه`;
                document.getElementById('total-net-profit').textContent = `${totalNetProfit.toFixed(2)} جنيه`;

                const allInvoices = await invoiceDB.getAllInvoices();
                displaySalesReport(allInvoices);
            } catch (error) {
                console.error('خطأ في تحميل التقارير:', error);
                showNotification('خطأ في تحميل التقارير', 'error');
            }
        }

        // Load saved invoices for display
        async function loadSavedInvoices() {
            try {
                const allInvoices = await invoiceDB.getAllInvoices();
                const tbody = document.getElementById('saved-invoices-table');
                
                if (allInvoices.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice"></i>
                                    <h3>لا توجد فواتير محفوظة</h3>
                                    <p>لم يتم حفظ أي فواتير بعد.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = allInvoices.map(invoice => `
                    <tr>
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.date}</td>
                        <td>${invoice.customerName}</td>
                        <td>${invoice.customerPhone || 'لا يوجد'}</td>
                        <td>${(invoice.subtotal || 0).toFixed(2)} جنيه</td>
                        <td>${(invoice.paidAmount || 0).toFixed(2)} جنيه</td>
                        <td>${(invoice.remainingAmount || 0).toFixed(2)} جنيه</td>
                        <td>
                            <span class="status status-${invoice.status}">
                                ${getStatusText(invoice.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewInvoiceDetails(${invoice.id})">
                                <i class="fas fa-eye"></i> عرض
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('خطأ في تحميل الفواتير المحفوظة:', error);
                showNotification('خطأ في تحميل الفواتير المحفوظة', 'error');
            }
        }

        function toggleProductForm() {
            const form = document.getElementById('add-product-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            loadCategories();
        }

        function addCategory() {
            const nameInput = document.getElementById('new-category-name');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('يرجى إدخال اسم الفئة', 'error');
                return;
            }

            const newCategory = {
                id: Date.now(),
                name: name
            };

            categories.push(newCategory);
            localStorage.setItem('categories', JSON.stringify(categories));
            
            nameInput.value = '';
            loadCategories();
            showNotification('تم إضافة الفئة بنجاح', 'success');
        }

        function deleteCategory(categoryId) {
            showDeleteConfirmation('category', categoryId);
        }

        async function saveProduct() {
            const name = document.getElementById('product-name').value.trim();
            const categoryId = document.getElementById('product-category').value;
            const wholesalePrice = parseFloat(document.getElementById('wholesale-price').value) || 0;
            const price = parseFloat(document.getElementById('product-price').value) || 0;
            const quantity = parseInt(document.getElementById('product-quantity').value) || 0;
            const minStock = parseInt(document.getElementById('min-stock').value) || 5;

            if (!name || !categoryId || price <= 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            const newProduct = {
                name: name,
                categoryId: parseInt(categoryId),
                wholesalePrice: wholesalePrice,
                price: price,
                quantity: quantity,
                minStock: minStock
            };

            try {
                await invoiceDB.saveProduct(newProduct);
                
                // Clear form
                document.getElementById('product-name').value = '';
                document.getElementById('product-category').value = '';
                document.getElementById('wholesale-price').value = '';
                document.getElementById('product-price').value = '';
                document.getElementById('product-quantity').value = '';
                document.getElementById('min-stock').value = '';
                
                await loadInventory();
                showNotification('تم إضافة المنتج بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في حفظ المنتج:', error);
                showNotification('خطأ في حفظ المنتج', 'error');
            }
        }

        function editQuantity(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const newQuantity = prompt('أدخل الكمية الجديدة:', product.quantity);
            if (newQuantity === null) return;

            const quantity = parseInt(newQuantity);
            if (isNaN(quantity)) {
                showNotification('يرجى إدخال كمية صحيحة', 'error');
                return;
            }

            product.quantity = quantity;
            localStorage.setItem('products', JSON.stringify(products));
            loadInventory();
            showNotification('تم تحديث الكمية بنجاح', 'success');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Fill form with product data
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-category').value = product.categoryId;
            document.getElementById('wholesale-price').value = product.wholesalePrice || 0;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-quantity').value = product.quantity;
            document.getElementById('min-stock').value = product.minStock || 5;

            // Show form
            document.getElementById('add-product-form').style.display = 'block';

            // Change save button to update
            const saveBtn = document.getElementById('save-product-btn');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> تحديث المنتج';
            saveBtn.onclick = () => updateProduct(productId);
        }

        function updateProduct(productId) {
            const name = document.getElementById('product-name').value.trim();
            const categoryId = document.getElementById('product-category').value;
            const wholesalePrice = parseFloat(document.getElementById('wholesale-price').value) || 0;
            const price = parseFloat(document.getElementById('product-price').value) || 0;
            const quantity = parseInt(document.getElementById('product-quantity').value) || 0;
            const minStock = parseInt(document.getElementById('min-stock').value) || 5;

            if (!name || !categoryId || price <= 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;

            products[productIndex] = {
                ...products[productIndex],
                name: name,
                categoryId: parseInt(categoryId),
                wholesalePrice: wholesalePrice,
                price: price,
                quantity: quantity,
                minStock: minStock
            };

            localStorage.setItem('products', JSON.stringify(products));
            
            // Clear form and reset button
            document.getElementById('product-name').value = '';
            document.getElementById('product-category').value = '';
            document.getElementById('wholesale-price').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-quantity').value = '';
            document.getElementById('min-stock').value = '';
            
            const saveBtn = document.getElementById('save-product-btn');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> حفظ المنتج';
            saveBtn.onclick = saveProduct;
            
            loadInventory();
            showNotification('تم تحديث المنتج بنجاح', 'success');
        }

        function addToSale(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingProduct = selectedProducts.find(p => p.id === productId);
            
            if (existingProduct) {
                existingProduct.quantity++;
            } else {
                selectedProducts.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    maxQuantity: product.quantity
                });
            }

            displaySelectedProducts();
            updateSaleSummary();
        }
        function displaySelectedProducts() {
            const container = document.getElementById('selected-products');
            
            if (selectedProducts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-basket"></i>
                        <h3>لم يتم تحديد أي منتجات</h3>
                        <p>اختر المنتجات من القائمة أعلاه لإضافتها إلى البيع.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = selectedProducts.map(product => `
                <div class="sale-product-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${product.name}</h4>
                            <p>السعر: ${product.price.toFixed(2)} جنيه</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn btn-sm btn-info" onclick="changeQuantity(${product.id}, -1)">-</button>
                            <span style="font-weight: bold; min-width: 30px; text-align: center;">${product.quantity}</span>
                            <button class="btn btn-sm btn-info" onclick="changeQuantity(${product.id}, 1)">+</button>
                            <button class="btn btn-sm btn-danger" onclick="removeFromSale(${product.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>الإجمالي: ${(product.price * product.quantity).toFixed(2)} جنيه</strong>
                    </div>
                </div>
            `).join('');
        }

        function changeQuantity(productId, change) {
            const selectedProduct = selectedProducts.find(p => p.id === productId);
            if (!selectedProduct) return;

            const newQuantity = selectedProduct.quantity + change;
            
            if (newQuantity <= 0) {
                removeFromSale(productId);
                return;
            }

            selectedProduct.quantity = newQuantity;
            displaySelectedProducts();
            updateSaleSummary();
        }

        function removeFromSale(productId) {
            selectedProducts = selectedProducts.filter(p => p.id !== productId);
            displaySelectedProducts();
            updateSaleSummary();
        }

        function updateSaleSummary() {
            const summaryDiv = document.getElementById('sale-summary');
            
            if (selectedProducts.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }

            summaryDiv.style.display = 'block';
            
            const subtotal = selectedProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            document.getElementById('subtotal').textContent = `${subtotal.toFixed(2)} جنيه`;
            
            calculateRemainingAmount();
        }

        function calculateRemainingAmount() {
            const subtotal = selectedProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
            const remaining = subtotal - paidAmount;
            
            document.getElementById('remaining-amount').textContent = `${remaining.toFixed(2)} جنيه`;
        }

        async function completeSale() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const saleDate = document.getElementById('sale-date').value;
            const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
            const orderStatus = document.getElementById('order-status').value;
            const notes = document.getElementById('sale-notes').value.trim();

            if (!customerName || selectedProducts.length === 0) {
                showNotification('يرجى إدخال اسم العميل وتحديد المنتجات', 'error');
                return;
            }

            const subtotal = selectedProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            const remaining = subtotal - paidAmount;

            const newSale = {
                invoiceNumber: `INV-${Date.now()}`,
                customerName: customerName,
                customerPhone: customerPhone,
                date: saleDate,
                products: [...selectedProducts],
                subtotal: subtotal,
                paidAmount: paidAmount,
                remainingAmount: remaining,
                status: orderStatus,
                notes: notes
            };

            try {
                // Save invoice to database
                await invoiceDB.saveInvoice(newSale);

                // Update product quantities in database
                for (const selectedProduct of selectedProducts) {
                    const product = products.find(p => p.id === selectedProduct.id);
                    if (product) {
                        product.quantity -= selectedProduct.quantity;
                        await invoiceDB.updateProduct(product.id, product);
                    }
                }

                // Add sale to revenues if paid amount > 0
                if (paidAmount > 0) {
                    const revenue = {
                        id: Date.now() + 1,
                        description: `مبيعات - ${customerName} - ${customerPhone || 'بدون رقم'} - فاتورة ${newSale.invoiceNumber}`,
                        amount: paidAmount,
                        date: saleDate
                    };
                    revenues.push(revenue);
                    localStorage.setItem('revenues', JSON.stringify(revenues));
                }

                // Clear form
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                document.getElementById('paid-amount').value = '';
                document.getElementById('order-status').value = 'pending';
                document.getElementById('sale-notes').value = '';
                selectedProducts = [];
                
                displaySelectedProducts();
                updateSaleSummary();
                
                showNotification('تم تسجيل البيع بنجاح', 'success');
                
                // Switch to dashboard to show the new sale
                switchTab('dashboard');
            } catch (error) {
                console.error('خطأ في حفظ البيع:', error);
                showNotification('خطأ في حفظ البيع', 'error');
            }
        }

        function addExpense() {
            const description = document.getElementById('expense-description').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const date = document.getElementById('expense-date').value;

            if (!description || !amount || amount <= 0 || !date) {
                showNotification('يرجى ملء جميع حقول المصروف', 'error');
                return;
            }

            const newExpense = {
                id: Date.now(),
                description: description,
                amount: amount,
                date: date
            };

            expenses.push(newExpense);
            localStorage.setItem('expenses', JSON.stringify(expenses));

            // Clear form
            document.getElementById('expense-description').value = '';
            document.getElementById('expense-amount').value = '';
            
            loadExpenses();
            showNotification('تم إضافة المصروف بنجاح', 'success');
        }

        function addRevenue() {
            const description = document.getElementById('revenue-description').value.trim();
            const amount = parseFloat(document.getElementById('revenue-amount').value);
            const date = document.getElementById('revenue-date').value;

            if (!description || !amount || amount <= 0 || !date) {
                showNotification('يرجى ملء جميع حقول الإيراد', 'error');
                return;
            }

            const newRevenue = {
                id: Date.now(),
                description: description,
                amount: amount,
                date: date
            };

            revenues.push(newRevenue);
            localStorage.setItem('revenues', JSON.stringify(revenues));

            // Clear form
            document.getElementById('revenue-description').value = '';
            document.getElementById('revenue-amount').value = '';
            
            loadExpenses();
            showNotification('تم إضافة الإيراد بنجاح', 'success');
        }

        function filterExpenses() {
            const filterDate = document.getElementById('filter-expense-date').value;
            
            if (!filterDate) {
                displayExpenses(expenses, 'expenses-list');
                displayRevenues(revenues, 'revenue-list');
                return;
            }

            const filteredExpenses = expenses.filter(expense => expense.date === filterDate);
            const filteredRevenues = revenues.filter(revenue => revenue.date === filterDate);
            
            displayExpenses(filteredExpenses, 'expenses-list');
            displayRevenues(filteredRevenues, 'revenue-list');
        }

        function clearExpenseFilter() {
            document.getElementById('filter-expense-date').value = '';
            displayExpenses(expenses, 'expenses-list');
            displayRevenues(revenues, 'revenue-list');
        }

        function displayExpenses(expensesList, containerId) {
            const container = document.getElementById(containerId);
            
            if (expensesList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <h3>لا توجد مصروفات مسجلة</h3>
                        <p>لم يتم تسجيل أي مصروفات بعد.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = expensesList.map(expense => `
                <div class="sale-product-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${expense.description}</h4>
                            <p>${expense.date}</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <strong style="color: var(--expense);">${expense.amount.toFixed(2)} جنيه</strong>
                            <button class="btn btn-sm btn-danger" onclick="showDeleteConfirmation('expense', ${expense.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayRevenues(revenuesList, containerId) {
            const container = document.getElementById(containerId);
            
            if (revenuesList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-coins"></i>
                        <h3>لا توجد إيرادات مسجلة</h3>
                        <p>لم يتم تسجيل أي إيرادات بعد.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = revenuesList.map(revenue => `
                <div class="sale-product-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${revenue.description}</h4>
                            <p>${revenue.date}</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <strong style="color: var(--income);">${revenue.amount.toFixed(2)} جنيه</strong>
                            <button class="btn btn-sm btn-danger" onclick="showDeleteConfirmation('revenue', ${revenue.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displaySales(salesList, containerId) {
            const container = document.getElementById(containerId);
            
            if (salesList.length === 0) {
                const emptyMessage = containerId === 'sales-list' ? 
                    { icon: 'fas fa-file-invoice', title: 'لا توجد مبيعات مسجلة', desc: 'لم تقم بإضافة أي مبيعات بعد. يمكنك البدء بإضافة بيع جديد باستخدام الزر بالأعلى.' } :
                    { icon: 'fas fa-history', title: 'لا توجد مبيعات سابقة', desc: 'لم يتم تسجيل أي مبيعات سابقة بعد.' };
                
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="${emptyMessage.icon}"></i>
                        <h3>${emptyMessage.title}</h3>
                        <p>${emptyMessage.desc}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = salesList.map(sale => `
                <div class="sale-product-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${sale.customerName} - ${sale.customerPhone || 'لا يوجد رقم'}</h4>
                            <p>فاتورة: ${sale.invoiceNumber}</p>
                            <p>${sale.date}</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="text-align: center;">
                                <div>${(sale.subtotal || 0).toFixed(2)} جنيه</div>
                                <small>الإجمالي</small>
                            </div>
                            <div style="text-align: center;">
                                <div class="editable-amount" onclick="openInvoiceModal(${sale.id})" style="cursor: pointer; color: var(--primary); text-decoration: underline;">${(sale.paidAmount || 0).toFixed(2)} جنيه</div>
                                <small>المدفوع</small>
                            </div>
                            <div style="text-align: center;">
                                <div>${(sale.remainingAmount || 0).toFixed(2)} جنيه</div>
                                <small>المتبقي</small>
                            </div>
                            <div class="editable-status status status-${sale.status}" onclick="editSaleStatus(${sale.id})">
                                ${getStatusText(sale.status)}
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="showDeleteConfirmation('sale', ${sale.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displaySalesReport(salesList) {
            const tbody = document.getElementById('sales-report-table');
            
            if (salesList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <h3>لا توجد بيانات مبيعات</h3>
                                <p>لم يتم تسجيل أي مبيعات في الفترة المحددة.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = salesList.map(sale => `
                <tr>
                    <td>${sale.invoiceNumber}</td>
                    <td>${sale.date}</td>
                    <td>${sale.customerName}</td>
                    <td class="editable-amount" onclick="editSaleAmount(${sale.id})">${(sale.subtotal || 0).toFixed(2)} جنيه</td>
                    <td>${(sale.paidAmount || 0).toFixed(2)} جنيه</td>
                    <td>${(sale.remainingAmount || 0).toFixed(2)} جنيه</td>
                    <td>
                        <div class="editable-status status status-${sale.status}" onclick="editSaleStatus(${sale.id})">
                            ${getStatusText(sale.status)}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="showDeleteConfirmation(\'sale\', ${sale.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join("");
        }

        function editSaleAmount(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            const newAmount = prompt('أدخل المبلغ الجديد:', sale.subtotal);
            if (newAmount === null) return;

            const amount = parseFloat(newAmount);
            if (isNaN(amount) || amount <= 0) {
                showNotification('يرجى إدخال مبلغ صحيح', 'error');
                return;
            }

            sale.subtotal = amount;
            sale.remainingAmount = amount - sale.paidAmount;
            localStorage.setItem('sales', JSON.stringify(sales));
            
            loadData();
            showNotification('تم تحديث المبلغ بنجاح', 'success');
        }

        function editSaleStatus(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            const statuses = [
                { value: 'pending', text: 'معلق' },
                { value: 'in-progress', text: 'قيد التنفيذ' },
                { value: 'completed', text: 'مكتمل' },
                { value: 'cancelled', text: 'ملغي' }
            ];

            const currentIndex = statuses.findIndex(s => s.value === sale.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            sale.status = statuses[nextIndex].value;
            localStorage.setItem('sales', JSON.stringify(sales));
            
            loadData();
            showNotification('تم تحديث حالة الطلب بنجاح', 'success');
        }

        function generateReport() {
            const fromDate = document.getElementById('report-from-date').value;
            const toDate = document.getElementById('report-to-date').value;
            
            let filteredSales = sales;
            
            if (fromDate && toDate) {
                filteredSales = sales.filter(sale => sale.date >= fromDate && sale.date <= toDate);
            } else if (fromDate) {
                filteredSales = sales.filter(sale => sale.date >= fromDate);
            } else if (toDate) {
                filteredSales = sales.filter(sale => sale.date <= toDate);
            }
            
            displaySalesReport(filteredSales);
        }

        function filterSales() {
            const filterDate = document.getElementById('filter-date').value;
            
            if (!filterDate) {
                loadDashboard();
                return;
            }

            const filteredSales = sales.filter(sale => sale.date === filterDate);
            displaySales(filteredSales, 'previous-sales-list');
        }

        function searchSales() {
            const searchTerm = document.getElementById('dashboard-search').value.toLowerCase();
            
            if (!searchTerm) {
                loadDashboard();
                return;
            }

            const filteredSales = sales.filter(sale => 
                sale.customerName.toLowerCase().includes(searchTerm) ||
                sale.invoiceNumber.toLowerCase().includes(searchTerm) ||
                (sale.customerPhone && sale.customerPhone.toLowerCase().includes(searchTerm))
            );
            
            displaySales(filteredSales, 'sales-list');
        }

        function filterProductsByCategory(categoryId) {
            const grid = document.getElementById('products-grid');
            
            let filteredProducts = products;
            if (categoryId !== 'all') {
                filteredProducts = products.filter(product => product.categoryId == categoryId);
            }

            if (filteredProducts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>لا توجد منتجات في هذه الفئة</h3>
                        <p>لم يتم إضافة أي منتجات في هذه الفئة بعد.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card" onclick="addToSale(${product.id})">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${product.price.toFixed(2)} جنيه</div>
                    <div class="product-stock">المتوفر: ${product.quantity}</div>
                    <div class="status ${getStockStatus(product.quantity, product.minStock || 5)}">${getStockStatusText(product.quantity, product.minStock || 5)}</div>
                </div>
            `).join('');
        }

        function getStockStatus(quantity, minStock) {
            if (quantity <= 0) return 'status-out-of-stock';
            if (quantity <= minStock) return 'status-low-stock';
            return 'status-in-stock';
        }

        function getStockStatusText(quantity, minStock) {
            if (quantity <= 0) return 'نفد المخزون';
            if (quantity <= minStock) return 'مخزون منخفض';
            return 'متوفر';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'معلق',
                'in-progress': 'قيد التنفيذ',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        function showDeleteConfirmation(type, id) {
            const modal = document.getElementById('confirmation-modal');
            const title = document.getElementById('confirmation-title');
            const message = document.getElementById('confirmation-message');
            
            const typeMap = {
                'product': 'المنتج',
                'category': 'الفئة',
                'sale': 'البيع',
                'expense': 'المصروف',
                'revenue': 'الإيراد'
            };
            
            title.textContent = `تأكيد حذف ${typeMap[type]}`;
            message.textContent = `هل أنت متأكد من أنك تريد حذف هذا ${typeMap[type]}؟ لا يمكن التراجع عن هذا الإجراء.`;
            
            confirmationCallback = () => deleteItem(type, id);
            modal.classList.add('show');
        }

        function confirmDelete() {
            if (confirmationCallback) {
                confirmationCallback();
                confirmationCallback = null;
            }
            cancelDelete();
        }

        function cancelDelete() {
            const modal = document.getElementById('confirmation-modal');
            modal.classList.remove('show');
            confirmationCallback = null;
        }

        function deleteItem(type, id) {
            switch(type) {
                case 'product':
                    products = products.filter(p => p.id !== id);
                    localStorage.setItem('products', JSON.stringify(products));
                    loadInventory();
                    break;
                case 'category':
                    categories = categories.filter(c => c.id !== id);
                    localStorage.setItem('categories', JSON.stringify(categories));
                    loadCategories();
                    break;
                case 'sale':
                    // Find the sale to be deleted
                    const saleToDelete = sales.find(s => s.id === id);
                    if (saleToDelete) {
                        // Add to deleted invoices with deletion timestamp
                        const deletedInvoice = {
                            ...saleToDelete,
                            deletedAt: new Date().toISOString(),
                            deletedDate: new Date().toLocaleDateString('ar-EG')
                        };
                        deletedInvoices.push(deletedInvoice);
                        localStorage.setItem('deletedInvoices', JSON.stringify(deletedInvoices));
                        
                        // Remove associated revenue entry
                        const oldRevenueDescription = `مبيعات - فاتورة ${saleToDelete.invoiceNumber}`;
                        const newRevenueDescription = `مبيعات - ${saleToDelete.customerName} - ${saleToDelete.customerPhone || 'بدون رقم'} - فاتورة ${saleToDelete.invoiceNumber}`;
                        
                        revenues = revenues.filter(revenue => 
                            revenue.description !== oldRevenueDescription && 
                            revenue.description !== newRevenueDescription
                        );
                        localStorage.setItem('revenues', JSON.stringify(revenues));
                    }
                    
                    // Remove from sales
                    sales = sales.filter(s => s.id !== id);
                    localStorage.setItem('sales', JSON.stringify(sales));
                    loadData();
                    break;
                case 'deleted-invoice':
                    // Handle permanent deletion of deleted invoices
                    deletedInvoices = deletedInvoices.filter(invoice => invoice.id !== id);
                    localStorage.setItem('deletedInvoices', JSON.stringify(deletedInvoices));
                    loadDeletedInvoices();
                    showNotification('تم الحذف النهائي للفاتورة', 'success');
                    return; // Return early to avoid the generic success message
                case 'expense':
                    expenses = expenses.filter(e => e.id !== id);
                    localStorage.setItem('expenses', JSON.stringify(expenses));
                    loadExpenses();
                    break;
                case 'revenue':
                    revenues = revenues.filter(r => r.id !== id);
                    localStorage.setItem('revenues', JSON.stringify(revenues));
                    loadExpenses();
                    break;
            }
            showNotification('تم الحذف بنجاح', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            
            const iconMap = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${iconMap[type]}"></i>
                </div>
                <div class="notification-content">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 400);
            }, 3000);
        }

        // Product Modal Functions
        let currentEditingProductId = null;

        function openProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            currentEditingProductId = productId;
            
            // Fill modal with current product data
            document.getElementById('modal-wholesale-price').value = product.wholesalePrice || 0;
            document.getElementById('modal-selling-price').value = product.price || 0;
            document.getElementById('modal-quantity').value = product.quantity || 0;
            
            // Show modal
            const modal = document.getElementById('product-edit-modal');
            modal.classList.add('show');
        }

        function closeProductModal() {
            const modal = document.getElementById('product-edit-modal');
            modal.classList.remove('show');
            currentEditingProductId = null;
        }

        function saveProductChanges() {
            if (!currentEditingProductId) return;

            const wholesalePrice = parseFloat(document.getElementById('modal-wholesale-price').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('modal-selling-price').value) || 0;
            const quantity = parseInt(document.getElementById('modal-quantity').value) || 0;

            if (sellingPrice <= 0) {
                showNotification('يرجى إدخال سعر بيع صحيح', 'error');
                return;
            }

            // Find and update product
            const productIndex = products.findIndex(p => p.id === currentEditingProductId);
            if (productIndex === -1) return;

            products[productIndex].wholesalePrice = wholesalePrice;
            products[productIndex].price = sellingPrice;
            products[productIndex].quantity = quantity;

            // Save to localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // Refresh inventory display
            loadInventory();
            
            // Close modal and show success message
            closeProductModal();
            showNotification('تم تحديث المنتج بنجاح', 'success');
        }

        // Invoice Modal Functions
        let currentEditingSaleId = null;

        function openInvoiceModal(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            currentEditingSaleId = saleId;
            
            // Fill modal with current sale data
            document.getElementById('modal-paid-amount').value = sale.paidAmount || 0;
            
            // Show modal
            const modal = document.getElementById('invoice-edit-modal');
            modal.classList.add('show');
        }

        function closeInvoiceModal() {
            const modal = document.getElementById('invoice-edit-modal');
            modal.classList.remove('show');
            currentEditingSaleId = null;
        }

        function saveInvoiceChanges() {
            if (!currentEditingSaleId) return;

            const paidAmount = parseFloat(document.getElementById('modal-paid-amount').value) || 0;

            if (paidAmount < 0) {
                showNotification('يرجى إدخال مبلغ صحيح', 'error');
                return;
            }

            // Find and update sale
            const saleIndex = sales.findIndex(s => s.id === currentEditingSaleId);
            if (saleIndex === -1) return;

            const sale = sales[saleIndex];
            const oldPaidAmount = sale.paidAmount || 0;
            
            // Update sale amounts
            sale.paidAmount = paidAmount;
            sale.remainingAmount = sale.subtotal - paidAmount;

            // Update revenues list - remove old revenue entry and add new one
            updateRevenueForSale(sale, oldPaidAmount, paidAmount);

            // Save to localStorage
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('revenues', JSON.stringify(revenues));
            
            // Refresh displays
            loadDashboard();
            loadExpenses(); // This will refresh the revenues display too
            
            // Close modal and show success message
            closeInvoiceModal();
            showNotification('تم تحديث الفاتورة وقائمة الإيرادات بنجاح', 'success');
        }

        function updateRevenueForSale(sale, oldPaidAmount, newPaidAmount) {
            // Find existing revenue entry for this sale (check both old and new description formats)
            const oldRevenueDescription = `مبيعات - فاتورة ${sale.invoiceNumber}`;
            const newRevenueDescription = `مبيعات - ${sale.customerName} - ${sale.customerPhone || 'بدون رقم'} - فاتورة ${sale.invoiceNumber}`;
            
            let existingRevenue = revenues.find(revenue => 
                revenue.description === oldRevenueDescription || 
                revenue.description === newRevenueDescription
            );
            
            if (existingRevenue) {
                // Update existing revenue entry
                if (newPaidAmount > 0) {
                    existingRevenue.amount = newPaidAmount;
                    existingRevenue.description = newRevenueDescription; // Update to new format
                    existingRevenue.date = sale.date;
                } else {
                    // Remove revenue entry if paid amount is 0
                    revenues = revenues.filter(revenue => revenue.id !== existingRevenue.id);
                }
            } else {
                // Create new revenue entry if none exists and paid amount > 0
                if (newPaidAmount > 0) {
                    const newRevenue = {
                        id: Date.now() + Math.random(), // Ensure unique ID
                        description: newRevenueDescription,
                        amount: newPaidAmount,
                        date: sale.date
                    };
                    revenues.push(newRevenue);
                }
            }
        }

        // Financial Reports Filter Functions
        function filterFinancialReports() {
            const fromDate = document.getElementById('financial-from-date').value;
            const toDate = document.getElementById('financial-to-date').value;
            
            if (!fromDate || !toDate) {
                showNotification('يرجى تحديد تاريخ البداية والنهاية', 'warning');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                showNotification('تاريخ البداية يجب أن يكون قبل تاريخ النهاية', 'error');
                return;
            }
            
            // Filter revenues by date range
            const filteredRevenues = revenues.filter(revenue => {
                const revenueDate = new Date(revenue.date);
                return revenueDate >= new Date(fromDate) && revenueDate <= new Date(toDate);
            });
            
            // Filter expenses by date range
            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= new Date(fromDate) && expenseDate <= new Date(toDate);
            });
            
            // Calculate totals for the filtered period
            const totalRevenue = filteredRevenues.reduce((sum, revenue) => sum + revenue.amount, 0);
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalRevenue - totalExpenses;
            
            // Update display
            document.getElementById('total-revenue').textContent = `${totalRevenue.toFixed(2)} جنيه`;
            document.getElementById('total-expenses').textContent = `${totalExpenses.toFixed(2)} جنيه`;
            document.getElementById('total-net-profit').textContent = `${netProfit.toFixed(2)} جنيه`;
            
            // Update net profit color based on value
            const netProfitElement = document.getElementById('total-net-profit');
            if (netProfit > 0) {
                netProfitElement.style.color = 'var(--income)';
            } else if (netProfit < 0) {
                netProfitElement.style.color = 'var(--expense)';
            } else {
                netProfitElement.style.color = 'var(--gray)';
            }
            
            showNotification(`تم فلترة التقارير للفترة من ${fromDate} إلى ${toDate}`, 'success');
        }
        
        function clearFinancialFilter() {
            // Clear date inputs
            document.getElementById('financial-from-date').value = '';
            document.getElementById('financial-to-date').value = '';
            
            // Reload all financial data
            loadReports();
            
            showNotification('تم إزالة فلتر التقارير المالية', 'info');
        }

        // Admin Panel Functions
        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const errorMessage = document.getElementById('admin-error-message');
            
            if (password === 'admin1822') {
                isAdminLoggedIn = true;
                document.getElementById('admin-login-section').style.display = 'none';
                document.getElementById('admin-panel-section').style.display = 'block';
                loadDeletedInvoices();
                showNotification('تم تسجيل الدخول بنجاح', 'success');
            } else {
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
            }
            
            // Clear password field
            document.getElementById('admin-password').value = '';
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            document.getElementById('admin-login-section').style.display = 'block';
            document.getElementById('admin-panel-section').style.display = 'none';
            document.getElementById('admin-password').value = '';
            showNotification('تم تسجيل الخروج', 'info');
        }

        function loadAdminPanel() {
            if (!isAdminLoggedIn) {
                document.getElementById('admin-login-section').style.display = 'block';
                document.getElementById('admin-panel-section').style.display = 'none';
            } else {
                document.getElementById('admin-login-section').style.display = 'none';
                document.getElementById('admin-panel-section').style.display = 'block';
                loadDeletedInvoices();
            }
        }

        function loadDeletedInvoices() {
            const tbody = document.getElementById('deleted-invoices-table');
            
            if (deletedInvoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <div class="empty-state">
                                <i class="fas fa-trash-alt"></i>
                                <h3>لا توجد فواتير محذوفة</h3>
                                <p>لم يتم حذف أي فواتير بعد.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = deletedInvoices.map(invoice => `
                <tr>
                    <td>${invoice.invoiceNumber}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.customerName}</td>
                    <td>${invoice.customerPhone || 'لا يوجد'}</td>
                    <td>${(invoice.subtotal || 0).toFixed(2)} جنيه</td>
                    <td>${(invoice.paidAmount || 0).toFixed(2)} جنيه</td>
                    <td>${invoice.deletedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="restoreInvoice(${invoice.id})">
                            <i class="fas fa-undo"></i> استعادة
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="permanentlyDeleteInvoice(${invoice.id})">
                            <i class="fas fa-trash-alt"></i> حذف نهائي
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function searchDeletedInvoices() {
            const searchTerm = document.getElementById('deleted-search').value.toLowerCase();
            
            if (!searchTerm) {
                loadDeletedInvoices();
                return;
            }

            const filteredInvoices = deletedInvoices.filter(invoice => 
                invoice.customerName.toLowerCase().includes(searchTerm) ||
                invoice.invoiceNumber.toLowerCase().includes(searchTerm) ||
                (invoice.customerPhone && invoice.customerPhone.includes(searchTerm))
            );

            const tbody = document.getElementById('deleted-invoices-table');
            
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>لا توجد نتائج</h3>
                                <p>لم يتم العثور على فواتير محذوفة تطابق البحث.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredInvoices.map(invoice => `
                <tr>
                    <td>${invoice.invoiceNumber}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.customerName}</td>
                    <td>${invoice.customerPhone || 'لا يوجد'}</td>
                    <td>${(invoice.subtotal || 0).toFixed(2)} جنيه</td>
                    <td>${(invoice.paidAmount || 0).toFixed(2)} جنيه</td>
                    <td>${invoice.deletedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="restoreInvoice(${invoice.id})">
                            <i class="fas fa-undo"></i> استعادة
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="permanentlyDeleteInvoice(${invoice.id})">
                            <i class="fas fa-trash-alt"></i> حذف نهائي
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function restoreInvoice(invoiceId) {
            const invoiceToRestore = deletedInvoices.find(invoice => invoice.id === invoiceId);
            if (!invoiceToRestore) return;

            // Remove deletion metadata
            delete invoiceToRestore.deletedAt;
            delete invoiceToRestore.deletedDate;

            // Add back to sales
            sales.push(invoiceToRestore);
            localStorage.setItem('sales', JSON.stringify(sales));

            // Remove from deleted invoices
            deletedInvoices = deletedInvoices.filter(invoice => invoice.id !== invoiceId);
            localStorage.setItem('deletedInvoices', JSON.stringify(deletedInvoices));

            // Restore revenue entry if paid amount > 0
            if (invoiceToRestore.paidAmount > 0) {
                const revenueDescription = `مبيعات - ${invoiceToRestore.customerName} - ${invoiceToRestore.customerPhone || 'بدون رقم'} - فاتورة ${invoiceToRestore.invoiceNumber}`;
                const newRevenue = {
                    id: Date.now() + Math.random(),
                    description: revenueDescription,
                    amount: invoiceToRestore.paidAmount,
                    date: invoiceToRestore.date
                };
                revenues.push(newRevenue);
                localStorage.setItem('revenues', JSON.stringify(revenues));
            }

            // Refresh displays
            loadDeletedInvoices();
            loadData();
            showNotification('تم استعادة الفاتورة بنجاح', 'success');
        }

        function permanentlyDeleteInvoice(invoiceId) {
            showDeleteConfirmation('deleted-invoice', invoiceId);
        }
    </script>

    <!-- Product Edit Modal -->
    <div class="modal-overlay" id="product-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="edit-product">تعديل المنتج</h3>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="modal-form-group">
                <label class="modal-label" data-i18n="wholesale-price">سعر الجملة</label>
                <input type="number" class="modal-input" id="modal-wholesale-price" step="0.01" placeholder="0.00">
            </div>
            <div class="modal-form-group">
                <label class="modal-label" data-i18n="selling-price">سعر البيع</label>
                <input type="number" class="modal-input" id="modal-selling-price" step="0.01" placeholder="0.00">
            </div>
            <div class="modal-form-group">
                <label class="modal-label" data-i18n="quantity">الكمية</label>
                <input type="number" class="modal-input" id="modal-quantity" placeholder="0">
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeProductModal()" data-i18n="cancel">إلغاء</button>
                <button class="modal-btn modal-btn-primary" onclick="saveProductChanges()" data-i18n="save">حفظ</button>
            </div>
        </div>
    </div>

    <!-- Invoice Edit Modal -->
    <div class="modal-overlay" id="invoice-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="edit-invoice">تعديل الفاتورة</h3>
                <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
            </div>
            <div class="modal-form-group">
                <label class="modal-label" data-i18n="paid-amount">المبلغ المدفوع</label>
                <input type="number" class="modal-input" id="modal-paid-amount" step="0.01" placeholder="0.00">
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeInvoiceModal()" data-i18n="cancel">إلغاء</button>
                <button class="modal-btn modal-btn-primary" onclick="saveInvoiceChanges()" data-i18n="save">حفظ</button>
            </div>
        </div>
    </div>
</body>
</html>


        // Search invoices function
        async function searchInvoices() {
            const searchTerm = document.getElementById('invoice-search').value.trim();
            
            try {
                let invoices;
                if (searchTerm) {
                    invoices = await invoiceDB.searchInvoices(searchTerm);
                } else {
                    invoices = await invoiceDB.getAllInvoices();
                }
                
                const tbody = document.getElementById('saved-invoices-table');
                
                if (invoices.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-search"></i>
                                    <h3>لا توجد نتائج</h3>
                                    <p>لم يتم العثور على فواتير تطابق البحث.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = invoices.map(invoice => `
                    <tr>
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.date}</td>
                        <td>${invoice.customerName}</td>
                        <td>${invoice.customerPhone || 'لا يوجد'}</td>
                        <td>${(invoice.subtotal || 0).toFixed(2)} جنيه</td>
                        <td>${(invoice.paidAmount || 0).toFixed(2)} جنيه</td>
                        <td>${(invoice.remainingAmount || 0).toFixed(2)} جنيه</td>
                        <td>
                            <span class="status status-${invoice.status}">
                                ${getStatusText(invoice.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewInvoiceDetails(${invoice.id})">
                                <i class="fas fa-eye"></i> عرض
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('خطأ في البحث:', error);
                showNotification('خطأ في البحث', 'error');
            }
        }

        // Export data function
        async function exportData() {
            try {
                const data = await invoiceDB.exportData();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `enjoy-gifts-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                showNotification('تم تصدير البيانات بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير البيانات:', error);
                showNotification('خطأ في تصدير البيانات', 'error');
            }
        }

        // Import data function
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (confirm('هل أنت متأكد من استيراد البيانات؟ سيتم استبدال جميع البيانات الحالية.')) {
                    await invoiceDB.importData(data);
                    await loadData();
                    showNotification('تم استيراد البيانات بنجاح', 'success');
                }
            } catch (error) {
                console.error('خطأ في استيراد البيانات:', error);
                showNotification('خطأ في استيراد البيانات: ' + error.message, 'error');
            }
            
            // Clear file input
            event.target.value = '';
        }

        // View invoice details
        async function viewInvoiceDetails(invoiceId) {
            try {
                const invoice = await invoiceDB.getInvoice(invoiceId);
                if (!invoice) {
                    showNotification('لم يتم العثور على الفاتورة', 'error');
                    return;
                }

                let details = `
                    رقم الفاتورة: ${invoice.invoiceNumber}
                    التاريخ: ${invoice.date}
                    العميل: ${invoice.customerName}
                    رقم الهاتف: ${invoice.customerPhone || 'لا يوجد'}
                    
                    المنتجات:
                `;

                if (invoice.products && invoice.products.length > 0) {
                    invoice.products.forEach(product => {
                        details += `\n- ${product.name}: ${product.quantity} × ${product.price} = ${(product.quantity * product.price).toFixed(2)} جنيه`;
                    });
                }

                details += `
                    
                    إجمالي المبلغ: ${(invoice.subtotal || 0).toFixed(2)} جنيه
                    المدفوع: ${(invoice.paidAmount || 0).toFixed(2)} جنيه
                    المتبقي: ${(invoice.remainingAmount || 0).toFixed(2)} جنيه
                    الحالة: ${getStatusText(invoice.status)}
                `;

                if (invoice.notes) {
                    details += `\nملاحظات: ${invoice.notes}`;
                }

                alert(details);
            } catch (error) {
                console.error('خطأ في عرض تفاصيل الفاتورة:', error);
                showNotification('خطأ في عرض تفاصيل الفاتورة', 'error');
            }
        }

        // Delete invoice
        async function deleteInvoice(invoiceId) {
            if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
                try {
                    await invoiceDB.deleteInvoice(invoiceId);
                    await loadSavedInvoices();
                    showNotification('تم حذف الفاتورة بنجاح', 'success');
                } catch (error) {
                    console.error('خطأ في حذف الفاتورة:', error);
                    showNotification('خطأ في حذف الفاتورة', 'error');
                }
            }
        }

        // Get status text in Arabic
        function getStatusText(status) {
            const statusMap = {
                'pending': 'معلق',
                'in-progress': 'قيد التنفيذ',
                'completed': 'مكتمل',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

