<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enjoy The Gifts-Store system</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ألوان الوضع النهاري */
            --primary: #6a5acd;
            --primary-light: #8a7cff;
            --secondary: #9370db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --light-bg: #f8f9ff;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --gray: #7f8c8d;
            --card-bg: #ffffff;
            --card-shadow: rgba(99, 99, 99, 0.15) 0px 2px 8px 0px;
            --border: #e0e0e0;
            --expense: #e74c3c;
            --expense-light: rgba(231, 76, 60, 0.1);
            --income: #2ecc71;
            --income-light: rgba(46, 204, 113, 0.1);
            /* ألوان الوضع الليلي */
            --dark-bg: #121212;
            --dark-card: #1e1e1e;
            --dark-text: #e0e0e0;
            --dark-border: #333333;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            transition: background-color 0.4s, color 0.3s, border-color 0.4s;
        }
        body {
            background: var(--light-bg);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            animation: headerGlow 3s infinite alternate;
        }
        @keyframes headerGlow {
            0% { box-shadow: var(--card-shadow); }
            100% { box-shadow: 0 0 20px rgba(106, 90, 205, 0.3), var(--card-shadow); }
        }
        body.dark-mode header {
            background: linear-gradient(90deg, #2c2250, #3a2a6c);
        }
        header::before {
            content: "";
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        header::after {
            content: "";
            position: absolute;
            bottom: -30px;
            left: -30px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2;
            animation: fadeInUp 0.5s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .logo i {
            font-size: 2.5rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
        }
        .logo span {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 100;
        }
        body.dark-mode .theme-toggle {
            color: var(--dark-text);
        }
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg);
        }
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            position: relative;
            z-index: 10;
        }
        body.dark-mode .nav-tabs {
            background: var(--dark-card);
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            font-size: 1.1rem;
            position: relative;
        }
        body.dark-mode .tab {
            color: var(--dark-text);
        }
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: rgba(106, 90, 205, 0.05);
        }
        body.dark-mode .tab.active {
            background: rgba(106, 90, 205, 0.1);
        }
        .tab:hover:not(.active) {
            background: rgba(106, 90, 205, 0.08);
        }
        .tab i {
            margin-left: 8px;
        }
        .tab-content {
            display: none;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            animation: fadeIn 0.5s;
            border: 1px solid rgba(106, 90, 205, 0.1);
        }
        body.dark-mode .tab-content {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section-title {
            font-size: 1.8rem;
            margin: 0 0 25px;
            color: var(--primary);
            position: relative;
            padding-bottom: 15px;
            font-weight: 700;
        }
        body.dark-mode .section-title {
            color: var(--primary-light);
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 80px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }
        body.dark-mode .form-label {
            color: var(--dark-text);
        }
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
        }
        body.dark-mode .form-control {
            background: #2a2a2a;
            border: 2px solid var(--dark-border);
            color: var(--dark-text);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2);
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #5949b8;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(106, 90, 205, 0.3);
        }
        .btn-sm {
            padding: 10px 20px;
            font-size: 1rem;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-info {
            background: var(--info);
            color: white;
        }
        .btn-block {
            display: block;
            width: 100%;
        }
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin: 25px 0;
            background: white;
            border: 1px solid var(--border);
        }
        body.dark-mode .table-container {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            min-width: 800px;
        }
        body.dark-mode table {
            background: var(--dark-card);
        }
        th, td {
            padding: 18px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            font-size: 1.1rem;
        }
        body.dark-mode th, 
        body.dark-mode td {
            border-bottom: 1px solid var(--dark-border);
            color: var(--dark-text);
        }
        th {
            font-weight: 700;
            background: rgba(106, 90, 205, 0.05);
        }
        body.dark-mode th {
            background: rgba(106, 90, 205, 0.1);
        }
        thead {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
        }
        body.dark-mode thead {
            background: linear-gradient(90deg, #2c2250, #3a2a6c);
        }
        tbody tr:hover {
            background: rgba(106, 90, 205, 0.03);
        }
        body.dark-mode tbody tr:hover {
            background: rgba(106, 90, 205, 0.1);
        }
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            display: inline-block;
        }
        .status-in-stock {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
        }
        .status-low-stock {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        .status-out-of-stock {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-col {
            flex: 1;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .alert-success {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .alert-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
            <div class="logo">
                <i class="fas fa-gift"></i>
                <div>
                    <h1>Enjoy The Gifts</h1>
                    <span>نظام إدارة متجر الهدايا</span>
                </div>
            </div>
        </header>

        <div class="nav-tabs">
            <div class="tab active" onclick="showTab('products')">
                <i class="fas fa-box"></i>
                المنتجات
            </div>
            <div class="tab" onclick="showTab('sales')">
                <i class="fas fa-shopping-cart"></i>
                المبيعات
            </div>
            <div class="tab" onclick="showTab('customers')">
                <i class="fas fa-users"></i>
                العملاء
            </div>
            <div class="tab" onclick="showTab('expenses')">
                <i class="fas fa-money-bill-wave"></i>
                المصروفات
            </div>
            <div class="tab" onclick="showTab('reports')">
                <i class="fas fa-chart-bar"></i>
                التقارير
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content active">
            <h2 class="section-title">إدارة المنتجات</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">اسم المنتج</label>
                    <input type="text" id="productName" class="form-control" placeholder="أدخل اسم المنتج">
                </div>
                <div class="form-col">
                    <label class="form-label">الفئة</label>
                    <select id="productCategory" class="form-control">
                        <option value="">اختر الفئة</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">سعر البيع</label>
                    <input type="number" id="productPrice" class="form-control" placeholder="0.00" step="0.01">
                </div>
                <div class="form-col">
                    <label class="form-label">سعر التكلفة</label>
                    <input type="number" id="productCost" class="form-control" placeholder="0.00" step="0.01">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">الكمية المتاحة</label>
                    <input type="number" id="productStock" class="form-control" placeholder="0">
                </div>
                <div class="form-col">
                    <label class="form-label">الحد الأدنى للمخزون</label>
                    <input type="number" id="productMinStock" class="form-control" placeholder="5">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">الوصف</label>
                <textarea id="productDescription" class="form-control" rows="3" placeholder="وصف المنتج"></textarea>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="addProduct()">
                <i class="fas fa-plus"></i>
                إضافة منتج
            </button>
            
            <div id="productAlert"></div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الإجراءات</th>
                            <th>الحالة</th>
                            <th>الكمية</th>
                            <th>سعر التكلفة</th>
                            <th>سعر البيع</th>
                            <th>الفئة</th>
                            <th>اسم المنتج</th>
                            <th>#</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="8" class="loading show">
                                <div class="spinner"></div>
                                جاري تحميل المنتجات...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Tab -->
        <div id="sales" class="tab-content">
            <h2 class="section-title">إدارة المبيعات</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">اسم العميل</label>
                    <input type="text" id="customerName" class="form-control" placeholder="اسم العميل">
                </div>
                <div class="form-col">
                    <label class="form-label">رقم الهاتف</label>
                    <input type="text" id="customerPhone" class="form-control" placeholder="رقم الهاتف">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">المنتجات</label>
                <div id="saleItems">
                    <div class="form-row">
                        <div class="form-col">
                            <select class="form-control sale-product" onchange="updateProductPrice(this)">
                                <option value="">اختر المنتج</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <input type="number" class="form-control sale-quantity" placeholder="الكمية" min="1" onchange="calculateTotal()">
                        </div>
                        <div class="form-col">
                            <input type="number" class="form-control sale-price" placeholder="السعر" step="0.01" readonly>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-success btn-sm" onclick="addSaleItem()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">الخصم</label>
                    <input type="number" id="saleDiscount" class="form-control" placeholder="0.00" step="0.01" onchange="calculateTotal()">
                </div>
                <div class="form-col">
                    <label class="form-label">طريقة الدفع</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="نقدي">نقدي</option>
                        <option value="بطاقة">بطاقة</option>
                        <option value="تحويل">تحويل بنكي</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ملاحظات</label>
                <textarea id="saleNotes" class="form-control" rows="2" placeholder="ملاحظات إضافية"></textarea>
            </div>
            
            <div class="form-group">
                <h3>إجمالي المبلغ: <span id="totalAmount">0.00</span> ريال</h3>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="createSale()">
                <i class="fas fa-shopping-cart"></i>
                إتمام البيع
            </button>
            
            <div id="saleAlert"></div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الإجراءات</th>
                            <th>تاريخ البيع</th>
                            <th>طريقة الدفع</th>
                            <th>الحالة</th>
                            <th>المبلغ النهائي</th>
                            <th>الخصم</th>
                            <th>المبلغ الإجمالي</th>
                            <th>العميل</th>
                            <th>#</th>
                        </tr>
                    </thead>
                    <tbody id="salesTable">
                        <tr>
                            <td colspan="9" class="loading show">
                                <div class="spinner"></div>
                                جاري تحميل المبيعات...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <h2 class="section-title">إدارة العملاء</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">اسم العميل</label>
                    <input type="text" id="newCustomerName" class="form-control" placeholder="اسم العميل">
                </div>
                <div class="form-col">
                    <label class="form-label">رقم الهاتف</label>
                    <input type="text" id="newCustomerPhone" class="form-control" placeholder="رقم الهاتف">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">البريد الإلكتروني</label>
                    <input type="email" id="newCustomerEmail" class="form-control" placeholder="البريد الإلكتروني">
                </div>
                <div class="form-col">
                    <label class="form-label">العنوان</label>
                    <input type="text" id="newCustomerAddress" class="form-control" placeholder="العنوان">
                </div>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="addCustomer()">
                <i class="fas fa-user-plus"></i>
                إضافة عميل
            </button>
            
            <div id="customerAlert"></div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>تاريخ التسجيل</th>
                            <th>العنوان</th>
                            <th>البريد الإلكتروني</th>
                            <th>رقم الهاتف</th>
                            <th>اسم العميل</th>
                            <th>#</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable">
                        <tr>
                            <td colspan="6" class="loading show">
                                <div class="spinner"></div>
                                جاري تحميل العملاء...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <h2 class="section-title">إدارة المصروفات</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">وصف المصروف</label>
                    <input type="text" id="expenseDescription" class="form-control" placeholder="وصف المصروف">
                </div>
                <div class="form-col">
                    <label class="form-label">المبلغ</label>
                    <input type="number" id="expenseAmount" class="form-control" placeholder="0.00" step="0.01">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">الفئة</label>
                    <input type="text" id="expenseCategory" class="form-control" placeholder="فئة المصروف">
                </div>
                <div class="form-col">
                    <label class="form-label">التاريخ</label>
                    <input type="date" id="expenseDate" class="form-control">
                </div>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="addExpense()">
                <i class="fas fa-plus"></i>
                إضافة مصروف
            </button>
            
            <div id="expenseAlert"></div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الإجراءات</th>
                            <th>التاريخ</th>
                            <th>الفئة</th>
                            <th>المبلغ</th>
                            <th>الوصف</th>
                            <th>#</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTable">
                        <tr>
                            <td colspan="6" class="loading show">
                                <div class="spinner"></div>
                                جاري تحميل المصروفات...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2 class="section-title">التقارير والإحصائيات</h2>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="table-container">
                        <h3>ملخص المبيعات</h3>
                        <div id="salesSummary">
                            <div class="loading show">
                                <div class="spinner"></div>
                                جاري تحميل ملخص المبيعات...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-col">
                    <div class="table-container">
                        <h3>المنتجات منخفضة المخزون</h3>
                        <div id="lowStockProducts">
                            <div class="loading show">
                                <div class="spinner"></div>
                                جاري تحميل المنتجات منخفضة المخزون...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <h3>أفضل المنتجات مبيعاً</h3>
                <table>
                    <thead>
                        <tr>
                            <th>إجمالي الإيرادات</th>
                            <th>الكمية المباعة</th>
                            <th>اسم المنتج</th>
                        </tr>
                    </thead>
                    <tbody id="topProductsTable">
                        <tr>
                            <td colspan="3" class="loading show">
                                <div class="spinner"></div>
                                جاري تحميل أفضل المنتجات...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let products = [];
        let categories = [];
        let customers = [];
        let orders = [];
        let expenses = [];
        let currentSaleItems = [];

        // API base URL
        const API_BASE = '/api';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadProducts();
            loadCustomers();
            loadOrders();
            loadExpenses();
            loadReports();
            
            // Set today's date for expense form
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        });

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const themeIcon = document.querySelector('.theme-toggle i');
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.querySelector('.theme-toggle i').className = 'fas fa-sun';
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        // API helper functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(API_BASE + endpoint, options);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'حدث خطأ في الخادم');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Show alert messages
        function showAlert(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Categories functions
        async function loadCategories() {
            try {
                const result = await apiCall('/categories');
                categories = result.categories;
                
                // Update category dropdowns
                const categorySelects = document.querySelectorAll('#productCategory');
                categorySelects.forEach(select => {
                    select.innerHTML = '<option value="">اختر الفئة</option>';
                    categories.forEach(category => {
                        select.innerHTML += `<option value="${category.name}">${category.name}</option>`;
                    });
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Products functions
        async function loadProducts() {
            try {
                const result = await apiCall('/products');
                products = result.products;
                displayProducts();
                updateProductSelects();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsTable').innerHTML = '<tr><td colspan="8">حدث خطأ في تحميل المنتجات</td></tr>';
            }
        }

        function displayProducts() {
            const tbody = document.getElementById('productsTable');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">لا توجد منتجات</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => {
                const stockStatus = product.stock <= product.min_stock ? 
                    (product.stock === 0 ? 'status-out-of-stock' : 'status-low-stock') : 
                    'status-in-stock';
                const stockText = product.stock <= product.min_stock ? 
                    (product.stock === 0 ? 'نفد المخزون' : 'مخزون منخفض') : 
                    'متوفر';
                
                return `
                    <tr>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        <td><span class="status ${stockStatus}">${stockText}</span></td>
                        <td>${product.stock}</td>
                        <td>${product.cost} ريال</td>
                        <td>${product.price} ريال</td>
                        <td>${product.category}</td>
                        <td>${product.name}</td>
                        <td>${product.id}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateProductSelects() {
            const productSelects = document.querySelectorAll('.sale-product');
            productSelects.forEach(select => {
                select.innerHTML = '<option value="">اختر المنتج</option>';
                products.forEach(product => {
                    if (product.stock > 0) {
                        select.innerHTML += `<option value="${product.id}" data-price="${product.price}">${product.name} (متوفر: ${product.stock})</option>`;
                    }
                });
            });
        }

        async function addProduct() {
            try {
                const name = document.getElementById('productName').value;
                const category = document.getElementById('productCategory').value;
                const price = document.getElementById('productPrice').value;
                const cost = document.getElementById('productCost').value;
                const stock = document.getElementById('productStock').value;
                const minStock = document.getElementById('productMinStock').value || 5;
                const description = document.getElementById('productDescription').value;
                
                if (!name || !category || !price || !cost || !stock) {
                    showAlert('productAlert', 'يرجى ملء جميع الحقول المطلوبة', 'error');
                    return;
                }
                
                await apiCall('/products', 'POST', {
                    name, category, price, cost, stock, min_stock: minStock, description
                });
                
                showAlert('productAlert', 'تم إضافة المنتج بنجاح');
                
                // Clear form
                document.getElementById('productName').value = '';
                document.getElementById('productCategory').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productCost').value = '';
                document.getElementById('productStock').value = '';
                document.getElementById('productMinStock').value = '';
                document.getElementById('productDescription').value = '';
                
                // Reload products
                loadProducts();
            } catch (error) {
                showAlert('productAlert', error.message, 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                return;
            }
            
            try {
                await apiCall(`/products/${productId}`, 'DELETE');
                showAlert('productAlert', 'تم حذف المنتج بنجاح');
                loadProducts();
            } catch (error) {
                showAlert('productAlert', error.message, 'error');
            }
        }

        // Sales functions
        function updateProductPrice(select) {
            const priceInput = select.parentElement.nextElementSibling.nextElementSibling.querySelector('.sale-price');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.dataset.price) {
                priceInput.value = selectedOption.dataset.price;
            } else {
                priceInput.value = '';
            }
            calculateTotal();
        }

        function addSaleItem() {
            const saleItems = document.getElementById('saleItems');
            const newItem = document.createElement('div');
            newItem.className = 'form-row';
            newItem.innerHTML = `
                <div class="form-col">
                    <select class="form-control sale-product" onchange="updateProductPrice(this)">
                        <option value="">اختر المنتج</option>
                        ${products.filter(p => p.stock > 0).map(product => 
                            `<option value="${product.id}" data-price="${product.price}">${product.name} (متوفر: ${product.stock})</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-col">
                    <input type="number" class="form-control sale-quantity" placeholder="الكمية" min="1" onchange="calculateTotal()">
                </div>
                <div class="form-col">
                    <input type="number" class="form-control sale-price" placeholder="السعر" step="0.01" readonly>
                </div>
                <div class="form-col">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSaleItem(this)">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            `;
            saleItems.appendChild(newItem);
        }

        function removeSaleItem(button) {
            button.parentElement.parentElement.remove();
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            const saleItems = document.querySelectorAll('#saleItems .form-row');
            
            saleItems.forEach(item => {
                const quantity = parseFloat(item.querySelector('.sale-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.sale-price').value) || 0;
                total += quantity * price;
            });
            
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const finalTotal = total - discount;
            
            document.getElementById('totalAmount').textContent = finalTotal.toFixed(2);
        }

        async function createSale() {
            try {
                const customerName = document.getElementById('customerName').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const notes = document.getElementById('saleNotes').value;
                
                if (!customerName) {
                    showAlert('saleAlert', 'يرجى إدخال اسم العميل', 'error');
                    return;
                }
                
                // Collect sale items
                const items = [];
                const saleItems = document.querySelectorAll('#saleItems .form-row');
                
                for (let item of saleItems) {
                    const productId = item.querySelector('.sale-product').value;
                    const quantity = parseInt(item.querySelector('.sale-quantity').value);
                    const price = parseFloat(item.querySelector('.sale-price').value);
                    
                    if (productId && quantity && price) {
                        items.push({
                            product_id: productId,
                            quantity: quantity,
                            unit_price: price
                        });
                    }
                }
                
                if (items.length === 0) {
                    showAlert('saleAlert', 'يرجى إضافة منتج واحد على الأقل', 'error');
                    return;
                }
                
                const totalAmount = items.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
                
                await apiCall('/orders', 'POST', {
                    customer_name: customerName,
                    customer_phone: customerPhone,
                    total_amount: totalAmount,
                    discount: discount,
                    payment_method: paymentMethod,
                    notes: notes,
                    items: items
                });
                
                showAlert('saleAlert', 'تم إتمام البيع بنجاح');
                
                // Clear form
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('saleDiscount').value = '';
                document.getElementById('saleNotes').value = '';
                document.getElementById('saleItems').innerHTML = `
                    <div class="form-row">
                        <div class="form-col">
                            <select class="form-control sale-product" onchange="updateProductPrice(this)">
                                <option value="">اختر المنتج</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <input type="number" class="form-control sale-quantity" placeholder="الكمية" min="1" onchange="calculateTotal()">
                        </div>
                        <div class="form-col">
                            <input type="number" class="form-control sale-price" placeholder="السعر" step="0.01" readonly>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-success btn-sm" onclick="addSaleItem()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('totalAmount').textContent = '0.00';
                
                // Reload data
                loadProducts();
                loadOrders();
                updateProductSelects();
            } catch (error) {
                showAlert('saleAlert', error.message, 'error');
            }
        }

        async function loadOrders() {
            try {
                const result = await apiCall('/orders');
                orders = result.orders;
                displayOrders();
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('salesTable').innerHTML = '<tr><td colspan="9">حدث خطأ في تحميل المبيعات</td></tr>';
            }
        }

        function displayOrders() {
            const tbody = document.getElementById('salesTable');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">لا توجد مبيعات</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewOrderDetails(${order.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                    <td>${new Date(order.created_at).toLocaleDateString('ar-SA')}</td>
                    <td>${order.payment_method}</td>
                    <td><span class="status status-${order.status}">${order.status}</span></td>
                    <td>${order.final_amount} ريال</td>
                    <td>${order.discount} ريال</td>
                    <td>${order.total_amount} ريال</td>
                    <td>${order.customer_name}</td>
                    <td>${order.id}</td>
                </tr>
            `).join('');
        }

        async function viewOrderDetails(orderId) {
            try {
                const result = await apiCall(`/orders/${orderId}`);
                const order = result.order;
                const items = result.items;
                
                let itemsHtml = items.map(item => `
                    <tr>
                        <td>${item.product_name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit_price} ريال</td>
                        <td>${item.total_price} ريال</td>
                    </tr>
                `).join('');
                
                const detailsHtml = `
                    <div style="background: white; padding: 20px; border-radius: 10px; max-width: 600px;">
                        <h3>تفاصيل الطلب #${order.id}</h3>
                        <p><strong>العميل:</strong> ${order.customer_name}</p>
                        <p><strong>الهاتف:</strong> ${order.customer_phone || 'غير محدد'}</p>
                        <p><strong>التاريخ:</strong> ${new Date(order.created_at).toLocaleDateString('ar-SA')}</p>
                        <p><strong>طريقة الدفع:</strong> ${order.payment_method}</p>
                        <p><strong>الحالة:</strong> ${order.status}</p>
                        
                        <h4>المنتجات:</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">المنتج</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">الكمية</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">السعر</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px;">
                            <p><strong>المبلغ الإجمالي:</strong> ${order.total_amount} ريال</p>
                            <p><strong>الخصم:</strong> ${order.discount} ريال</p>
                            <p><strong>المبلغ النهائي:</strong> ${order.final_amount} ريال</p>
                        </div>
                        
                        ${order.notes ? `<p><strong>ملاحظات:</strong> ${order.notes}</p>` : ''}
                        
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 10px 20px; background: #6a5acd; color: white; border: none; border-radius: 5px; cursor: pointer;">إغلاق</button>
                    </div>
                `;
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
                overlay.innerHTML = detailsHtml;
                document.body.appendChild(overlay);
                
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });
            } catch (error) {
                alert('حدث خطأ في تحميل تفاصيل الطلب');
            }
        }

        // Customers functions
        async function loadCustomers() {
            try {
                const result = await apiCall('/customers');
                customers = result.customers;
                displayCustomers();
            } catch (error) {
                console.error('Error loading customers:', error);
                document.getElementById('customersTable').innerHTML = '<tr><td colspan="6">حدث خطأ في تحميل العملاء</td></tr>';
            }
        }

        function displayCustomers() {
            const tbody = document.getElementById('customersTable');
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">لا يوجد عملاء</td></tr>';
                return;
            }
            
            tbody.innerHTML = customers.map(customer => `
                <tr>
                    <td>${new Date(customer.created_at).toLocaleDateString('ar-SA')}</td>
                    <td>${customer.address || 'غير محدد'}</td>
                    <td>${customer.email || 'غير محدد'}</td>
                    <td>${customer.phone || 'غير محدد'}</td>
                    <td>${customer.name}</td>
                    <td>${customer.id}</td>
                </tr>
            `).join('');
        }

        async function addCustomer() {
            try {
                const name = document.getElementById('newCustomerName').value;
                const phone = document.getElementById('newCustomerPhone').value;
                const email = document.getElementById('newCustomerEmail').value;
                const address = document.getElementById('newCustomerAddress').value;
                
                if (!name) {
                    showAlert('customerAlert', 'يرجى إدخال اسم العميل', 'error');
                    return;
                }
                
                await apiCall('/customers', 'POST', {
                    name, phone, email, address
                });
                
                showAlert('customerAlert', 'تم إضافة العميل بنجاح');
                
                // Clear form
                document.getElementById('newCustomerName').value = '';
                document.getElementById('newCustomerPhone').value = '';
                document.getElementById('newCustomerEmail').value = '';
                document.getElementById('newCustomerAddress').value = '';
                
                // Reload customers
                loadCustomers();
            } catch (error) {
                showAlert('customerAlert', error.message, 'error');
            }
        }

        // Expenses functions
        async function loadExpenses() {
            try {
                const result = await apiCall('/expenses');
                expenses = result.expenses;
                displayExpenses();
            } catch (error) {
                console.error('Error loading expenses:', error);
                document.getElementById('expensesTable').innerHTML = '<tr><td colspan="6">حدث خطأ في تحميل المصروفات</td></tr>';
            }
        }

        function displayExpenses() {
            const tbody = document.getElementById('expensesTable');
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">لا توجد مصروفات</td></tr>';
                return;
            }
            
            tbody.innerHTML = expenses.map(expense => `
                <tr>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    <td>${expense.date}</td>
                    <td>${expense.category || 'غير محدد'}</td>
                    <td>${expense.amount} ريال</td>
                    <td>${expense.description}</td>
                    <td>${expense.id}</td>
                </tr>
            `).join('');
        }

        async function addExpense() {
            try {
                const description = document.getElementById('expenseDescription').value;
                const amount = document.getElementById('expenseAmount').value;
                const category = document.getElementById('expenseCategory').value;
                const date = document.getElementById('expenseDate').value;
                
                if (!description || !amount) {
                    showAlert('expenseAlert', 'يرجى ملء الحقول المطلوبة', 'error');
                    return;
                }
                
                await apiCall('/expenses', 'POST', {
                    description, amount, category, date
                });
                
                showAlert('expenseAlert', 'تم إضافة المصروف بنجاح');
                
                // Clear form
                document.getElementById('expenseDescription').value = '';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseCategory').value = '';
                
                // Reload expenses
                loadExpenses();
            } catch (error) {
                showAlert('expenseAlert', error.message, 'error');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                return;
            }
            
            try {
                await apiCall(`/expenses/${expenseId}`, 'DELETE');
                showAlert('expenseAlert', 'تم حذف المصروف بنجاح');
                loadExpenses();
            } catch (error) {
                showAlert('expenseAlert', error.message, 'error');
            }
        }

        // Reports functions
        async function loadReports() {
            try {
                // Load sales summary
                const salesSummary = await apiCall('/reports/sales-summary');
                document.getElementById('salesSummary').innerHTML = `
                    <p><strong>إجمالي الطلبات:</strong> ${salesSummary.total_orders}</p>
                    <p><strong>إجمالي المبيعات:</strong> ${salesSummary.total_sales} ريال</p>
                `;
                
                // Load low stock products
                const lowStock = await apiCall('/reports/low-stock');
                if (lowStock.products.length === 0) {
                    document.getElementById('lowStockProducts').innerHTML = '<p>جميع المنتجات متوفرة بكميات كافية</p>';
                } else {
                    document.getElementById('lowStockProducts').innerHTML = lowStock.products.map(product => `
                        <p style="color: var(--danger);"><strong>${product.name}:</strong> ${product.current_stock} (الحد الأدنى: ${product.min_stock})</p>
                    `).join('');
                }
                
                // Load top products
                const topProducts = await apiCall('/reports/top-products');
                const topProductsTable = document.getElementById('topProductsTable');
                if (topProducts.products.length === 0) {
                    topProductsTable.innerHTML = '<tr><td colspan="3">لا توجد بيانات مبيعات</td></tr>';
                } else {
                    topProductsTable.innerHTML = topProducts.products.map(product => `
                        <tr>
                            <td>${product.total_revenue} ريال</td>
                            <td>${product.total_sold}</td>
                            <td>${product.name}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }
    </script>
</body>
</html>

